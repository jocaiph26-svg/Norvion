{% extends "base.html" %}
{% block content %}
  <div class="header">
    <div>
      <h1 class="h1">History</h1>
      <p class="sub">Saved runs (stored snapshots).</p>
    </div>
  </div>
  <style>
    .clickrow { cursor: pointer; }
    .clickrow:hover { background: rgba(2,6,23,0.03); }
  </style>

  {% if runs and runs|length > 0 %}
    <div class="card">
      <div class="card-b" style="padding:0;">
        <table class="table">
          <thead>
            <tr>
              <th>Date (UTC)</th>
              <th>File</th>
              <th>Period end</th>
              <th>Cash</th>
              <th>Coverage</th>
              <th>Completeness</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          {% for r in runs %}
            <tr class="clickrow" onclick="window.location='/run/{{ r.id }}'">
              <td class="mono">{{ r.created_at|humandt }}</td>
              <td style="font-weight:800;">
                {{ r.filename }}
                {% if latest_run_id and r.id != latest_run_id %}
                  <span class="badge muted" style="margin-left:6px;">Snapshot</span>
                {% endif %}
              </td>
              <td>{{ r.end_date }}</td>
              <td>{{ r.current_cash | money(r.currency) }}</td>
              <td>
                {% if r.runway_days is not none and r.runway_days <= 0 %}
                  โค0 days
                {% elif r.runway_days is not none %}
                  {{ '%.0f'|format(r.runway_days) }} days
                {% endif %}
              </td>
              <td style="font-weight:900;">
                {% if r.quality_score is not none %}
                  {{ '%.0f'|format(r.quality_score) }}/100{% if r.quality_band %} ({{ r.quality_band }}){% endif %}
                {% endif %}
              </td>
              <td><a class="btn btn-sm btn-ghost" href="/run/{{ r.id }}">Open</a></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        <div class="small" style="padding:12px 20px; color:var(--muted); border-top:1px solid var(--border);">
          Coverage: historical cash balance รท daily expense at analysis time (stored). Completeness: system-derived indicator (does not certify accuracy).
        </div>
      </div>
    </div>
  {% else %}
    <div class="card">
      <div class="card-b">
        <div class="empty">
          <div class="empty-title">No snapshots yet</div>
          <div class="empty-sub">
            Upload transaction data to generate your first deterministic snapshot.
            Each run is stored as an immutable audit record.
          </div>
          {% if access_role in ['operator', 'manager', 'admin'] %}
          <a class="btn" href="/upload" style="margin-top:16px;">Upload CSV</a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
