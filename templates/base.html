<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or "Norvion" }}</title>

  <!-- Icons -->
  <link rel="icon" href="/static/favicon.ico">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">

  <!-- Styles -->
  <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
  {# Defensive: never assume request/run_qs are present #}
  {% set path = request.url.path if request is defined and request.url is defined else '' %}
  {% set rq_raw = run_qs if run_qs is defined and run_qs else '' %}
  {# Ensure rq is either "" or begins with "?" #}
  {% set rq = rq_raw if (rq_raw and rq_raw.startswith('?')) else ('?' ~ rq_raw) if rq_raw else '' %}
  {% set run_link_id = active_run_id if active_run_id else (latest_run_id if latest_run_id else None) %}

  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div>Norvion</div>
        <small>Snapshot review</small>
        {% if access_role is defined %}
          <details class="access-context">
            <summary>Access context</summary>
            <div class="access-context-body">
              <div class="pill dim">Role: <span class="mono">{{ access_role }}</span></div>
              {% if access_tenant %}<div class="pill dim">Tenant: <span class="mono">{{ access_tenant }}</span></div>{% endif %}
              {% if access_actor %}<div class="pill dim">Actor: <span class="mono">{{ access_actor }}</span></div>{% endif %}
            </div>
          </details>
        {% endif %}
      </div>

      <nav class="sidebar-nav">
        <a href="/dashboard{{ rq }}"
           class="{{ 'active' if path in ['/', '/home', '/dashboard'] else '' }}">
          Home
        </a>
        {% if run_link_id %}
          <a href="{{ '/run/' ~ run_link_id ~ rq }}"
             class="{{ 'active' if path.startswith('/run/') else '' }}">
            Run Detail
          </a>
        {% else %}
          <span class="nav-disabled" aria-disabled="true">Run Detail</span>
          <small class="nav-helper">Upload data to create the first run.</small>
        {% endif %}
        <a href="/alerts{{ rq }}"
           class="{{ 'active' if path.startswith('/alerts') else '' }}">
          Alerts
        </a>
        <a href="/insights{{ rq }}"
           class="{{ 'active' if path == '/insights' else '' }}">
          Summary
        </a>
        <a href="/history{{ rq }}"
           class="{{ 'active' if path.startswith('/history') else '' }}">
          History
        </a>
        {% if access_role in ['manager', 'admin'] %}
        <a href="/settings{{ rq }}"
           class="{{ 'active' if path.startswith('/settings') else '' }}">
          Settings
        </a>
        {% endif %}
        <a href="/integrations{{ rq }}"
           class="{{ 'active' if path.startswith('/integrations') else '' }}">
          Integrations
        </a>
        <a href="/digest/weekly{{ rq }}"
           class="{{ 'active' if path.startswith('/digest/weekly') else '' }}">
          Weekly Summary
        </a>
        {% if access_role == 'admin' %}
        <a href="/admin/users{{ rq }}"
           class="{{ 'active' if path.startswith('/admin/users') else '' }}">
          Users
        </a>
        {% endif %}
      </nav>

      {% if access_actor %}
      <div class="sidebar-footer" style="padding: 16px 20px; border-top: 1px solid var(--border); margin-top: auto;">
        <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">
          <span class="mono" style="font-size: 12px;">{{ access_actor }}</span>
        </div>
        <form method="post" action="/logout" style="margin: 0;">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
          <button type="submit" class="btn btn-ghost" style="width: 100%; font-size: 13px;">Log out</button>
        </form>
      </div>
      {% endif %}

    </aside>

    <div class="app-main">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="topbar-left">
            &nbsp;
          </div>
          <div class="topbar-actions">
            <a class="btn" href="/upload">Upload CSV</a>
          </div>
        </div>
      </header>

      <main class="container">
        {% block content %}{% endblock %}

        <div class="footer">
          <div class="hr"></div>
          <div>
            <strong>Disclaimer:</strong>
            Summaries computed from uploaded data using deterministic rules (stored at run time).
            Not financial advice. Verify with a qualified professional.
          </div>
          <div>
            Design goal:
            <strong>deterministic checks + stored evidence + audit trail</strong>
            (no black-box claims).
          </div>
          <div style="margin-top:8px;">
            <a href="/tos" style="color:var(--muted); text-decoration:none; font-size:13px;">Terms of Service</a>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="/static/app.js"></script>
</body>
</html>
