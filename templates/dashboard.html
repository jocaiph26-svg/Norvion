{% extends "base.html" %}
{% block content %}
  <div class="header">
    <div>
      <h1 class="h1">Snapshot {{ run_id }}</h1>
      <p class="sub">Recorded at: {{ created_at|humandt }}</p>
      {% if run_scope %}
        <div class="row" style="margin-top:8px; gap:8px;">
          {% if run_scope.is_latest %}
            <span class="badge">Latest</span>
          {% else %}
            <span class="badge">Stored snapshot (read-only)</span>
          {% endif %}
        </div>
      {% endif %}
    </div>
    <div class="row">
      {% if run_scope and not run_scope.is_latest %}
        <a class="btn btn-ghost" href="/latest">Return to latest</a>
      {% endif %}
    </div>
  </div>

  <div class="grid cols-4">
    <div class="card kpi">
      <div class="label">Cash position snapshot</div>
      <div class="value">
        {% if summary.current_cash is not none %}
          {{ summary.current_cash|money(summary.currency) }}
        {% else %}
          —
        {% endif %}
      </div>
      {# P1-C3: Inline metric definition for cash position #}
      <div class="hint">
        {% if summary.current_cash is not none %}
          <strong>Definition:</strong> Starting cash balance + cumulative net change from all transactions in the dataset.<br>
          This is a snapshot as of analysis time, not a real-time balance. Does not connect to live bank accounts.
        {% else %}
          Not available for this run.
        {% endif %}
      </div>
    </div>
    <div class="card kpi">
      <div class="label">Cash coverage snapshot (historical)</div>
      <div class="value">
        {% if summary.runway_days is not none and summary.runway_days <= 0 %}
          ≤0 days
        {% elif summary.runway_days is not none %}
          {{ '%.0f'|format(summary.runway_days) }} days
        {% else %}
          —
        {% endif %}
      </div>
      {# P1-C3: Inline metric definition for runway #}
      <div class="hint">
        {% if summary.runway_days is not none %}
          <strong>Definition:</strong> Current cash balance ÷ average daily expense from recent comparison window.<br>
          This is a backward-looking calculation based on historical spending patterns. It is not a forecast and does not predict future income, expense changes, or cash requirements.
        {% else %}
          Not available for this run.
        {% endif %}
      </div>
    </div>

    <div class="card kpi">
      <div class="label">Recent income</div>
      <div class="value">
        {% if summary.recent_income is defined and summary.recent_income is not none %}
          {{ summary.recent_income|money(summary.currency) }}
        {% else %}
          —
        {% endif %}
      </div>
      {# P1-C3: Inline metric definition for recent income #}
      <div class="hint">
        {% if summary.recent_income is defined and summary.recent_income is not none %}
          <strong>Definition:</strong> Total income (inflow transactions) recorded during the recent comparison window.<br>
          Used as a baseline for detecting income changes in the current period.
        {% else %}
          Not available for this run.
        {% endif %}
      </div>
    </div>
    <div class="card kpi">
      <div class="label">Recent expenses</div>
      <div class="value">
        {% if summary.recent_expense is defined and summary.recent_expense is not none %}
          {{ summary.recent_expense|money(summary.currency) }}
        {% else %}
          —
        {% endif %}
      </div>
      {# P1-C3: Inline metric definition for recent expenses #}
      <div class="hint">
        {% if summary.recent_expense is defined and summary.recent_expense is not none %}
          <strong>Definition:</strong> Total expenses (outflow transactions) recorded during the recent comparison window.<br>
          Used as a baseline for detecting expense changes in the current period.
        {% else %}
          Not available for this run.
        {% endif %}
      </div>
    </div>
    <div class="card kpi">
      <div class="label">Data completeness (system-derived)</div>
      <div class="value">
        {% if quality.score is not none %}
          {{ '%.0f'|format(quality.score) }}/100{% if quality.band %} ({{ quality.band }}){% endif %}
        {% elif quality.band %}
          {{ quality.band }}
        {% else %}
          —
        {% endif %}
      </div>
      {# P1-C3: Inline metric definition for data completeness #}
      <div class="hint">
        {% if quality.score is not none or quality.band %}
          <strong>Definition:</strong> A numeric score (0-100) measuring the presence and coverage of expected data fields in the uploaded CSV.<br>
          <details style="font-size:inherit; margin-top:4px;">
            <summary style="cursor:pointer;">Band thresholds: A≥85, B≥70, C≥50, D&lt;50</summary>
            <div style="margin-top:4px; font-size:11px; color:var(--muted); line-height:1.5;">
              Score penalties: uncategorised transactions (-25%), unknown counterparties (-20%), duplicate rate (-15%), plus factors for date coverage and required field detection (invoice number, direction). This score measures data structure only and does not certify accuracy or business validity.
            </div>
          </details>
        {% else %}
          Data completeness information is not available for this run.
        {% endif %}
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  {# P0-G2: Run immutability affordances #}
  <div class="callout" style="margin-bottom:14px; border-left:3px solid var(--border); background:var(--bg-dim);">
    <div style="font-weight:700; margin-bottom:6px;">Run immutability</div>
    <div class="small" style="line-height:1.6; color:var(--text);">
      This run is a stored snapshot created at {{ created_at|humandt }}. All values shown are exactly as recorded at run time. Runs are never modified or recomputed after creation. Each run preserves its own data snapshot, calculation results, and alert evaluations independently.
    </div>
  </div>

  <div class="card">
    <div class="card-b">
      <h2>What changed since prior run (stored)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Differences are stored at run creation and shown without recomputation.
        This is a point-in-time comparison, not trend analysis or forecasting.
      </div>
      {% if summary.run_to_run %}
        <div class="small" style="margin-top:8px; color:#334155;">
          Prior run: <span class="mono">#{{ summary.run_to_run.prior_run_id }}</span> ·
          <span class="mono">{{ summary.run_to_run.prior_created_at|humandt }}</span>
        </div>
        {% set money_fields = [
          "current_cash",
          "window_income",
          "window_expense",
          "window_net_change",
          "recent_income",
          "recent_expense",
          "concentration_expense_denominator"
        ] %}
        {% set pct_fields = ["income_change", "expense_change"] %}
        {% set day_fields = [
          "runway_days",
          "window_days_observed",
          "window_days_span_inclusive",
          "window_days_with_income",
          "window_days_with_expense",
          "window_missing_dates"
        ] %}
        {% set count_fields = ["window_transaction_count"] %}
        {% set field_labels = {
          "current_cash": "Current cash",
          "window_income": "Window income",
          "window_expense": "Window expense",
          "window_net_change": "Window net change",
          "recent_income": "Recent income",
          "recent_expense": "Recent expense",
          "income_change": "Income change",
          "expense_change": "Expense change",
          "runway_days": "Runway (days)",
          "window_days_observed": "Distinct dates observed",
          "window_days_span_inclusive": "Window span (inclusive)",
          "window_days_with_income": "Days with income",
          "window_days_with_expense": "Days with expense",
          "window_missing_dates": "Missing dates",
          "window_transaction_count": "Transactions in window",
          "concentration_expense_denominator": "Expense denominator"
        } %}
        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Field</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Current</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Prior</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Difference</th>
            </tr>
          </thead>
          <tbody>
            {% for item in summary.run_to_run.fields %}
              <tr>
                <td style="padding:6px 0;">
                  {{ field_labels[item.field] if item.field in field_labels else item.field|replace('_',' ')|title }}
                </td>
                <td style="padding:6px 0;">
                  {% if item.current is not none %}
                    {% if item.field in money_fields %}
                      {{ item.current|money(summary.currency) }}
                    {% elif item.field in pct_fields %}
                      {{ item.current|pct }}
                    {% elif item.field in day_fields %}
                      {{ item.current|num(0) }}
                    {% elif item.field in count_fields %}
                      {{ item.current|num(0) }}
                    {% else %}
                      {{ item.current|num(2) }}
                    {% endif %}
                  {% endif %}
                </td>
                <td style="padding:6px 0;">
                  {% if item.prior is not none %}
                    {% if item.field in money_fields %}
                      {{ item.prior|money(summary.currency) }}
                    {% elif item.field in pct_fields %}
                      {{ item.prior|pct }}
                    {% elif item.field in day_fields %}
                      {{ item.prior|num(0) }}
                    {% elif item.field in count_fields %}
                      {{ item.prior|num(0) }}
                    {% else %}
                      {{ item.prior|num(2) }}
                    {% endif %}
                  {% endif %}
                </td>
                <td style="padding:6px 0;">
                  {% if item.delta is not none %}
                    {% if item.field in money_fields %}
                      {{ item.delta|money(summary.currency) }}
                    {% elif item.field in pct_fields %}
                      {{ item.delta|pct }}
                    {% elif item.field in day_fields %}
                      {{ item.delta|num(0) }}
                    {% elif item.field in count_fields %}
                      {{ item.delta|num(0) }}
                    {% else %}
                      {{ item.delta|num(2) }}
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="margin-top:8px; color:var(--muted);">
          No prior run is available for comparison.
        </div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  {# P0-C1: Period-over-Period Summary Table #}
  {% if recent_runs and recent_runs|length > 1 %}
  <div class="card">
    <div class="card-b">
      <h2>Period-over-period summary (stored)</h2>
      <p class="sub" style="margin-top:6px;">Key metrics from recent runs, shown exactly as stored.</p>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        Each row represents one stored run snapshot. Values are not recalculated.
      </div>
      <div style="overflow-x:auto; margin-top:12px;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="border-bottom:2px solid var(--border);">
              <th style="text-align:left; padding:8px 4px; font-weight:700; white-space:nowrap;">Run</th>
              <th style="text-align:left; padding:8px 4px; font-weight:700; white-space:nowrap;">Period</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700; white-space:nowrap;">Income</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700; white-space:nowrap;">Expenses</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700; white-space:nowrap;">Net</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700; white-space:nowrap;">Cash</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700; white-space:nowrap;">Runway</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700; white-space:nowrap;">Alerts</th>
            </tr>
          </thead>
          <tbody>
            {% for run in recent_runs %}
              <tr style="border-bottom:1px solid var(--border); {% if run.id == run_id %}background:var(--bg-highlight);{% endif %}">
                <td style="padding:8px 4px;">
                  <a href="/run/{{ run.id }}" class="link" style="font-family:var(--font-mono); font-size:12px;">
                    #{{ run.id }}
                  </a>
                </td>
                <td style="padding:8px 4px; font-size:12px; white-space:nowrap;">
                  {% if run.window_start and run.window_end %}
                    {{ run.window_start }} to {{ run.window_end }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {% if run.window_income is not none %}
                    {{ run.window_income|money(run.currency) }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {% if run.window_expense is not none %}
                    {{ run.window_expense|money(run.currency) }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {% if run.window_net is not none %}
                    {{ run.window_net|money(run.currency) }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {% if run.current_cash is not none %}
                    {{ run.current_cash|money(run.currency) }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {% if run.runway_days is not none %}
                    {{ run.runway_days|num(0) }}d
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {{ run.alert_count }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        Current run is highlighted. All values are from stored run snapshots.
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>
  {% endif %}

  {# P0-C2: Same-Period-Prior-Year Comparison #}
  {% if prior_year_run %}
  <div class="card">
    <div class="card-b">
      <h2>Same-period prior-year comparison (stored)</h2>
      <p class="sub" style="margin-top:6px;">
        Comparison to stored run from approximately one year ago covering a similar period.
      </p>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        Current period: {{ summary.window_start_date or '—' }} to {{ summary.end_date or '—' }}<br>
        Prior-year period: {{ prior_year_run.window_start or '—' }} to {{ prior_year_run.window_end or '—' }}
        (Run <a href="/run/{{ prior_year_run.run_id }}" class="link">#{{ prior_year_run.run_id }}</a>)
      </div>
      <div style="margin-top:12px;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="border-bottom:2px solid var(--border);">
              <th style="text-align:left; padding:8px 4px; font-weight:700;">Metric</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700;">Current Period</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700;">Prior Year</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700;">Delta</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:8px 4px;">Income</td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.window_income is not none %}
                  {{ summary.window_income|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if prior_year_run.window_income is not none %}
                  {{ prior_year_run.window_income|money(prior_year_run.currency) }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.window_income is not none and prior_year_run.window_income is not none %}
                  {{ (summary.window_income - prior_year_run.window_income)|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:8px 4px;">Expenses</td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.window_expense is not none %}
                  {{ summary.window_expense|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if prior_year_run.window_expense is not none %}
                  {{ prior_year_run.window_expense|money(prior_year_run.currency) }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.window_expense is not none and prior_year_run.window_expense is not none %}
                  {{ (summary.window_expense - prior_year_run.window_expense)|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:8px 4px;">Net</td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.window_net_change is not none %}
                  {{ summary.window_net_change|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if prior_year_run.window_net is not none %}
                  {{ prior_year_run.window_net|money(prior_year_run.currency) }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.window_net_change is not none and prior_year_run.window_net is not none %}
                  {{ (summary.window_net_change - prior_year_run.window_net)|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:8px 4px;">Cash</td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.current_cash is not none %}
                  {{ summary.current_cash|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if prior_year_run.current_cash is not none %}
                  {{ prior_year_run.current_cash|money(prior_year_run.currency) }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.current_cash is not none and prior_year_run.current_cash is not none %}
                  {{ (summary.current_cash - prior_year_run.current_cash)|money(summary.currency or 'AUD') }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:8px 4px;">Runway</td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.runway_days is not none %}
                  {{ summary.runway_days|num(0) }}d
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if prior_year_run.runway_days is not none %}
                  {{ prior_year_run.runway_days|num(0) }}d
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {% if summary.runway_days is not none and prior_year_run.runway_days is not none %}
                  {{ (summary.runway_days - prior_year_run.runway_days)|num(0) }}d
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            <tr>
              <td style="padding:8px 4px;">Alerts</td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {{ alerts|length }}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {{ prior_year_run.alert_count }}
              </td>
              <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                {{ (alerts|length) - prior_year_run.alert_count }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        All values are from stored run snapshots. Deltas are arithmetic differences, not percentages or trends.
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>
  {% endif %}

  <div class="card">
    <div class="card-b">
      <h2>Alerts summary (stored)</h2>
      <p class="sub" style="margin-top:6px;">Alerts recorded in this run.</p>
      {% if alerts|length == 0 %}
        <div class="callout">
          <strong>No alerts were triggered for this run.</strong>
          <div style="margin-top:6px;">
            The absence of alerts does not indicate business health or data accuracy.
            Some checks may not have been evaluated if required data was missing.
          </div>
        </div>
      {% else %}
        <div class="row" style="margin-top:8px;">
          <div class="pill">Alerts recorded (stored): {{ alerts|length }}</div>
          <a class="btn btn-ghost" href="/alerts{{ run_qs if run_qs is defined else '' }}">Open Alerts</a>
        </div>
        <div style="margin-top:10px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Alert</th>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Severity (stored)</th>
              </tr>
            </thead>
            <tbody>
              {% for a in alerts[:5] %}
                <tr>
                  <td style="padding:6px 0;"><a class="link" href="/alerts/{{ a.id }}{{ run_qs if run_qs is defined else '' }}">{{ a.title }}</a></td>
                  <td style="padding:6px 0;">{{ a.severity|upper }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if alerts|length > 5 %}
            <div class="small" style="color:var(--muted); margin-top:6px;">Showing first 5 alerts.</div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  {# P0-B3: Near-Miss Visibility - Display metrics approaching thresholds #}
  {% set stored_settings = params.settings if params and params.settings else {} %}
  {# Build near-miss items from stored summary values and stored thresholds #}
  {% set near_miss_items = [] %}

  {# Runway near-miss: observed runway approaching threshold (runway < threshold triggers alert) #}
  {% if summary.runway_days is not none and stored_settings.low_cash_buffer_days is defined %}
    {% set threshold = stored_settings.low_cash_buffer_days %}
    {% set observed = summary.runway_days %}
    {# For runway: alert fires when observed < threshold, so proximity = threshold / observed (inverted) #}
    {# Near-miss when observed is close to but above threshold: observed/threshold between 1.0 and 1.25 (80-100% proximity) #}
    {% if threshold > 0 and observed >= threshold %}
      {% set ratio = threshold / observed %}
      {% if ratio >= 0.80 and ratio < 1.0 %}
        {% set _ = near_miss_items.append({
          'metric': 'Cash runway',
          'observed': observed|string ~ ' days',
          'threshold': threshold|string ~ ' days',
          'proximity': ((ratio * 100)|round(0))|int
        }) %}
      {% endif %}
    {% endif %}
  {% endif %}

  {# Expense spike near-miss: observed expense_change approaching threshold #}
  {% if summary.expense_change is not none and stored_settings.expense_spike_pct is defined %}
    {% set threshold = stored_settings.expense_spike_pct %}
    {% set observed = summary.expense_change %}
    {# Alert fires when observed > threshold #}
    {% if threshold > 0 and observed <= threshold and observed >= 0 %}
      {% set ratio = observed / threshold %}
      {% if ratio >= 0.80 and ratio < 1.0 %}
        {% set _ = near_miss_items.append({
          'metric': 'Expense change',
          'observed': ((observed * 100)|round(1))|string ~ '%',
          'threshold': ((threshold * 100)|round(1))|string ~ '%',
          'proximity': ((ratio * 100)|round(0))|int
        }) %}
      {% endif %}
    {% endif %}
  {% endif %}

  {# Revenue drop near-miss: observed income_change approaching negative threshold #}
  {% if summary.income_change is not none and stored_settings.revenue_drop_pct is defined %}
    {% set threshold = stored_settings.revenue_drop_pct %}
    {% set observed = summary.income_change %}
    {# Alert fires when observed < -threshold (income_change is negative for drops) #}
    {# Near-miss when observed is negative but not quite at -threshold #}
    {% if threshold > 0 and observed < 0 and observed >= -threshold %}
      {% set ratio = (-observed) / threshold %}
      {% if ratio >= 0.80 and ratio < 1.0 %}
        {% set _ = near_miss_items.append({
          'metric': 'Income change',
          'observed': ((observed * 100)|round(1))|string ~ '%',
          'threshold': '-' ~ ((threshold * 100)|round(1))|string ~ '%',
          'proximity': ((ratio * 100)|round(0))|int
        }) %}
      {% endif %}
    {% endif %}
  {% endif %}

  {# Concentration near-miss: top vendor/category share approaching threshold #}
  {% if summary.concentration_top_vendors_expense and summary.concentration_top_vendors_expense|length > 0 and stored_settings.concentration_threshold is defined %}
    {% set threshold = stored_settings.concentration_threshold %}
    {% set top_vendor = summary.concentration_top_vendors_expense[0] %}
    {% if top_vendor.share is defined and top_vendor.share is not none %}
      {% set observed = top_vendor.share %}
      {# Alert fires when observed > threshold #}
      {% if threshold > 0 and observed <= threshold and observed > 0 %}
        {% set ratio = observed / threshold %}
        {% if ratio >= 0.80 and ratio < 1.0 %}
          {% set _ = near_miss_items.append({
            'metric': 'Vendor concentration',
            'observed': ((observed * 100)|round(1))|string ~ '%',
            'threshold': ((threshold * 100)|round(1))|string ~ '%',
            'proximity': ((ratio * 100)|round(0))|int
          }) %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}

  {% if summary.concentration_top_categories_expense and summary.concentration_top_categories_expense|length > 0 and stored_settings.concentration_threshold is defined %}
    {% set threshold = stored_settings.concentration_threshold %}
    {% set top_category = summary.concentration_top_categories_expense[0] %}
    {% if top_category.share is defined and top_category.share is not none %}
      {% set observed = top_category.share %}
      {# Alert fires when observed > threshold #}
      {% if threshold > 0 and observed <= threshold and observed > 0 %}
        {% set ratio = observed / threshold %}
        {% if ratio >= 0.80 and ratio < 1.0 %}
          {% set _ = near_miss_items.append({
            'metric': 'Category concentration',
            'observed': ((observed * 100)|round(1))|string ~ '%',
            'threshold': ((threshold * 100)|round(1))|string ~ '%',
            'proximity': ((ratio * 100)|round(0))|int
          }) %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}

  <div class="card">
    <div class="card-b">
      <h2>Approaching thresholds (stored data)</h2>
      <p class="sub" style="margin-top:6px;">Metrics that reached 80-99% of configured thresholds but did not trigger alerts.</p>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        These values did not trigger alerts. Displayed for situational awareness only.
      </div>
      {% if near_miss_items|length == 0 %}
        <div class="callout" style="margin-top:12px;">
          No values approached alert thresholds for this run.
        </div>
      {% else %}
        <table style="width:100%; border-collapse:collapse; margin-top:12px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid var(--border); padding:8px 0;">Metric</th>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px 0;">Observed Value</th>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px 0;">Threshold</th>
              <th style="text-align:right; border-bottom:1px solid var(--border); padding:8px 0;">Proximity</th>
            </tr>
          </thead>
          <tbody>
            {% for item in near_miss_items %}
              <tr>
                <td style="padding:8px 0;">{{ item.metric }}</td>
                <td style="padding:8px 0; text-align:right; font-family:var(--font-mono);">{{ item.observed }}</td>
                <td style="padding:8px 0; text-align:right; font-family:var(--font-mono);">{{ item.threshold }}</td>
                <td style="padding:8px 0; text-align:right; font-family:var(--font-mono);">{{ item.proximity }}%</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  {# P0-S1: Category Breakdown Summary - Display stored expense categorisation #}
  {% if summary.charts and summary.charts.expense_breakdown and summary.charts.expense_breakdown|length > 0 %}
  <div class="card">
    <div class="card-b">
      <h2>Category distribution (stored)</h2>
      <p class="sub" style="margin-top:6px;">
        Expense categorisation as stored at run time. Categories shown reflect the categorisation applied during ingestion.
      </p>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        Showing top {{ summary.charts.expense_breakdown|length }} categories by expense amount.
      </div>
      <div style="margin-top:12px;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="border-bottom:2px solid var(--border);">
              <th style="text-align:left; padding:8px 4px; font-weight:700;">Category</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700;">Amount</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700;">Share</th>
            </tr>
          </thead>
          <tbody>
            {% set total_expense = summary.window_expense or 1.0 %}
            {% for item in summary.charts.expense_breakdown %}
              <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:8px 4px;">{{ item.label }}</td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {{ item.value|money(summary.currency or 'AUD') }}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {% if total_expense > 0 %}
                    {{ ((item.value / total_expense) * 100)|num(1) }}%
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        Total window expense: {{ summary.window_expense|money(summary.currency or 'AUD') if summary.window_expense is not none else '—' }}
      </div>
      <div class="small" style="margin-top:4px; color:var(--muted);">
        Categories are displayed as stored. "Uncategorised" appears if present in the data.
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>
  {% endif %}

  {# P0-S2: Top N Counterparties Summary - Display stored counterparty breakdown #}
  {% if summary.concentration_top_vendors_expense and summary.concentration_top_vendors_expense|length > 0 %}
  <div class="card">
    <div class="card-b">
      <h2>Top expense counterparties (stored)</h2>
      <p class="sub" style="margin-top:6px;">
        Expense counterparty breakdown as stored at run time. Counterparties shown reflect the identifiers captured during ingestion.
      </p>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        Showing top {{ summary.concentration_top_vendors_expense|length }} expense counterparties by amount.
      </div>
      <div style="margin-top:12px;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="border-bottom:2px solid var(--border);">
              <th style="text-align:left; padding:8px 4px; font-weight:700;">Counterparty</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700;">Amount</th>
              <th style="text-align:right; padding:8px 4px; font-weight:700;">Share</th>
            </tr>
          </thead>
          <tbody>
            {# share stored as fraction 0-1, multiply by 100 for percentage display #}
            {% for item in summary.concentration_top_vendors_expense %}
              <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:8px 4px;">{{ item.counterparty }}</td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {{ item.amount|money(summary.currency or 'AUD') }}
                </td>
                <td style="padding:8px 4px; text-align:right; font-family:var(--font-mono); font-size:12px;">
                  {{ (item.share * 100)|num(1) }}%
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        Total window expense: {{ summary.window_expense|money(summary.currency or 'AUD') if summary.window_expense is not none else '—' }}
      </div>
      <div class="small" style="margin-top:4px; color:var(--muted);">
        Counterparties are displayed as stored. "Unknown" appears if counterparty identifiers were not available.
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>
  {% endif %}

  <details class="card disclosure">
    <summary style="cursor:pointer; font-weight:900; padding:16px 20px;">Technical / audit details (stored)</summary>
    <div class="card-b" style="padding-top:6px;">
      <div class="card">
        <div class="card-b">
          <h2>Run context (stored)</h2>
          <div class="row" style="margin-top:8px; flex-wrap:wrap;">
            <div class="pill">Recorded at (stored): {{ created_at|humandt }}</div>
            {% if summary.window_start_date and summary.end_date %}
              <div class="pill dim">Window (stored): {{ summary.window_start_date }} to {{ summary.end_date }} (inclusive)</div>
            {% endif %}
            <div class="pill dim">Data completeness (stored): {{ '%.0f'|format(quality.score or 0) }}/100{% if quality.band %} ({{ quality.band }}){% endif %}</div>
          </div>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="card">
        <div class="card-b">
          <h2>Window totals (stored at run time)</h2>
          {% if summary.window_start_date and summary.end_date %}
            <div class="small" style="margin-top:6px; color:var(--muted);">
              Window: {{ summary.window_start_date }} to {{ summary.end_date }} (inclusive).
            </div>
          {% endif %}
          <div class="row" style="margin-top:10px;">
            {% if summary.window_income is not none %}
              <div class="pill">Window income (stored): {{ summary.window_income|money(summary.currency) }}</div>
            {% endif %}
            {% if summary.window_expense is not none %}
              <div class="pill dim">Window expense (stored): {{ summary.window_expense|money(summary.currency) }}</div>
            {% endif %}
            {% if summary.window_net_change is not none %}
              <div class="pill dim">Window net change (stored): {{ summary.window_net_change|money(summary.currency) }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="grid cols-2">
        <div class="card kpi">
          <div class="label">Income change (stored)</div>
          <div class="value">
            {% if summary.income_change is not none %}
              {{ summary.income_change|pct }}
            {% endif %}
          </div>
          <div class="hint">{% if summary.income_change is not none %}Stored comparison: recent vs prior window.{% endif %}</div>
        </div>
        <div class="card kpi">
          <div class="label">Expense change (stored)</div>
          <div class="value">
            {% if summary.expense_change is not none %}
              {{ summary.expense_change|pct }}
            {% endif %}
          </div>
          <div class="hint">{% if summary.expense_change is not none %}Stored comparison: recent vs prior window.{% endif %}</div>
        </div>
      </div>

      <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Coverage (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Distinct dates observed are counted from post-normalization rows within the window.
      </div>
      <div class="row" style="margin-top:10px;">
        {% if summary.window_transaction_count is not none %}
          <div class="pill">Transactions in window (stored): {{ summary.window_transaction_count }}</div>
        {% endif %}
        {% if summary.window_days_observed is not none %}
          <div class="pill dim">Distinct dates observed (stored): {{ summary.window_days_observed }}</div>
        {% endif %}
        {% if summary.window_days_span_inclusive is not none %}
          <div class="pill dim">Window span (stored, inclusive): {{ summary.window_days_span_inclusive }}</div>
        {% endif %}
      </div>
      <div class="row" style="margin-top:8px;">
        {% if summary.window_days_with_income is not none %}
          <div class="pill dim">Days with income (stored): {{ summary.window_days_with_income }}</div>
        {% endif %}
        {% if summary.window_days_with_expense is not none %}
          <div class="pill dim">Days with expense (stored): {{ summary.window_days_with_expense }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Coverage continuity (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Missing dates are counted as inclusive window span minus distinct dates observed.
      </div>
      <div class="row" style="margin-top:10px;">
        {% if summary.window_days_span_inclusive is not none %}
          <div class="pill">Window span (stored, inclusive): {{ summary.window_days_span_inclusive }}</div>
        {% endif %}
        {% if summary.window_days_observed is not none %}
          <div class="pill dim">Distinct dates observed (stored): {{ summary.window_days_observed }}</div>
        {% endif %}
        {% if summary.window_missing_dates is not none %}
          <div class="pill dim">Missing dates (stored): {{ summary.window_missing_dates }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Observed run snapshot (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Values below are stored for this run and shown without recomputation.
      </div>
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <tbody>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Run</td>
            <td style="padding:6px 0;">
              <div><span class="mono">run_id</span> {{ run_id }}</div>
              <div><span class="mono">created_at</span> {{ created_at|humandt }}</div>
              <div><span class="mono">filename</span> {{ filename }}</div>
            </td>
          </tr>
          {% if run_entity_id %}
            <tr>
              <td style="padding:6px 0; font-weight:800;">Entity</td>
              <td style="padding:6px 0;">
                <span class="mono">tenant_id</span> {{ run_entity_id }}
              </td>
            </tr>
          {% endif %}
          {% if summary.window_start_date or summary.end_date or summary.window_days_span_inclusive is not none %}
            <tr>
              <td style="padding:6px 0; font-weight:800;">Window</td>
              <td style="padding:6px 0;">
                {% if summary.window_start_date %}
                  <div><span class="mono">window_start_date</span> {{ summary.window_start_date }}</div>
                {% endif %}
                {% if summary.end_date %}
                  <div><span class="mono">end_date</span> {{ summary.end_date }}</div>
                {% endif %}
                {% if summary.window_days_span_inclusive is not none %}
                  <div><span class="mono">window_days_span_inclusive</span> {{ summary.window_days_span_inclusive }}</div>
                {% endif %}
              </td>
            </tr>
          {% endif %}
          <tr>
            <td style="padding:6px 0; font-weight:800;">Window totals</td>
            <td style="padding:6px 0;">
              {% if summary.window_income is not none %}
                <div><span class="mono">window_income</span> {{ summary.window_income|money(summary.currency) }}</div>
              {% endif %}
              {% if summary.window_expense is not none %}
                <div><span class="mono">window_expense</span> {{ summary.window_expense|money(summary.currency) }}</div>
              {% endif %}
              {% if summary.window_net_change is not none %}
                <div><span class="mono">window_net_change</span> {{ summary.window_net_change|money(summary.currency) }}</div>
              {% endif %}
            </td>
          </tr>
          {% if summary.window_transaction_count is not none or summary.window_days_observed is not none or summary.window_days_with_income is not none or summary.window_days_with_expense is not none or summary.window_missing_dates is not none %}
            <tr>
              <td style="padding:6px 0; font-weight:800;">Coverage</td>
              <td style="padding:6px 0;">
                {% if summary.window_transaction_count is not none %}
                  <div><span class="mono">window_transaction_count</span> {{ summary.window_transaction_count }}</div>
                {% endif %}
                {% if summary.window_days_observed is not none %}
                  <div><span class="mono">window_days_observed</span> {{ summary.window_days_observed }}</div>
                {% endif %}
                {% if summary.window_days_with_income is not none %}
                  <div><span class="mono">window_days_with_income</span> {{ summary.window_days_with_income }}</div>
                {% endif %}
                {% if summary.window_days_with_expense is not none %}
                  <div><span class="mono">window_days_with_expense</span> {{ summary.window_days_with_expense }}</div>
                {% endif %}
                {% if summary.window_missing_dates is not none %}
                  <div><span class="mono">window_missing_dates</span> {{ summary.window_missing_dates }}</div>
                {% endif %}
              </td>
            </tr>
          {% endif %}
          {% if quality.score is not none or quality.band %}
            <tr>
              <td style="padding:6px 0; font-weight:800;">Data completeness</td>
              <td style="padding:6px 0;">
                {% if quality.score is not none %}
                  <div><span class="mono">quality.score</span> {{ '%.0f'|format(quality.score) }}</div>
                {% endif %}
                {% if quality.band %}
                  <div><span class="mono">quality.band</span> {{ quality.band }}</div>
                {% endif %}
              </td>
            </tr>
          {% endif %}
          {% if summary.concentration_top_n is not none or summary.concentration_expense_denominator is not none %}
            <tr>
              <td style="padding:6px 0; font-weight:800;">Observed distribution</td>
              <td style="padding:6px 0;">
                {% if summary.concentration_top_n is not none %}
                  <div><span class="mono">concentration_top_n</span> {{ summary.concentration_top_n }}</div>
                {% endif %}
                {% if summary.concentration_expense_denominator is not none %}
                  <div><span class="mono">concentration_expense_denominator</span> {{ summary.concentration_expense_denominator|money(summary.currency) }}</div>
                {% endif %}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Run‑to‑run change ledger (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Differences are stored at run creation and shown without recomputation.
        This is a point-in-time comparison, not trend analysis or forecasting.
      </div>
      {% if summary.run_to_run %}
        <div class="small" style="margin-top:8px; color:#334155;">
          Prior run: <span class="mono">#{{ summary.run_to_run.prior_run_id }}</span> ·
          <span class="mono">{{ summary.run_to_run.prior_created_at|humandt }}</span>
        </div>
        {% set money_fields = [
          "current_cash",
          "window_income",
          "window_expense",
          "window_net_change",
          "recent_income",
          "recent_expense",
          "concentration_expense_denominator"
        ] %}
        {% set pct_fields = ["income_change", "expense_change"] %}
        {% set day_fields = [
          "runway_days",
          "window_days_observed",
          "window_days_span_inclusive",
          "window_days_with_income",
          "window_days_with_expense",
          "window_missing_dates"
        ] %}
        {% set count_fields = ["window_transaction_count"] %}
        {% set field_labels = {
          "current_cash": "Current cash",
          "window_income": "Window income",
          "window_expense": "Window expense",
          "window_net_change": "Window net change",
          "recent_income": "Recent income",
          "recent_expense": "Recent expense",
          "income_change": "Income change",
          "expense_change": "Expense change",
          "runway_days": "Runway (days)",
          "window_days_observed": "Distinct dates observed",
          "window_days_span_inclusive": "Window span (inclusive)",
          "window_days_with_income": "Days with income",
          "window_days_with_expense": "Days with expense",
          "window_missing_dates": "Missing dates",
          "window_transaction_count": "Transactions in window",
          "concentration_expense_denominator": "Expense denominator"
        } %}
        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Field</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Current</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Prior</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Difference</th>
            </tr>
          </thead>
          <tbody>
            {% for item in summary.run_to_run.fields %}
              <tr>
                <td style="padding:6px 0;">
                  {{ field_labels[item.field] if item.field in field_labels else item.field|replace('_',' ')|title }}
                  <div class="small mono" style="color:var(--meta); margin-top:4px;">field: {{ item.field }}</div>
                </td>
                <td style="padding:6px 0;">
                  {% if item.current is not none %}
                    {% if item.field in money_fields %}
                      {{ item.current|money(summary.currency) }}
                    {% elif item.field in pct_fields %}
                      {{ item.current|pct }}
                    {% elif item.field in day_fields %}
                      {{ item.current|num(0) }}
                    {% elif item.field in count_fields %}
                      {{ item.current|num(0) }}
                    {% else %}
                      {{ item.current|num(2) }}
                    {% endif %}
                  {% endif %}
                </td>
                <td style="padding:6px 0;">
                  {% if item.prior is not none %}
                    {% if item.field in money_fields %}
                      {{ item.prior|money(summary.currency) }}
                    {% elif item.field in pct_fields %}
                      {{ item.prior|pct }}
                    {% elif item.field in day_fields %}
                      {{ item.prior|num(0) }}
                    {% elif item.field in count_fields %}
                      {{ item.prior|num(0) }}
                    {% else %}
                      {{ item.prior|num(2) }}
                    {% endif %}
                  {% endif %}
                </td>
                <td style="padding:6px 0;">
                  {% if item.delta is not none %}
                    {% if item.field in money_fields %}
                      {{ item.delta|money(summary.currency) }}
                    {% elif item.field in pct_fields %}
                      {{ item.delta|pct }}
                    {% elif item.field in day_fields %}
                      {{ item.delta|num(0) }}
                    {% elif item.field in count_fields %}
                      {{ item.delta|num(0) }}
                    {% else %}
                      {{ item.delta|num(2) }}
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="margin-top:8px; color:var(--muted);">
          No prior run is available for comparison.
        </div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Observed variability (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Daily min/max/std values are stored for this run and shown without recomputation.
      </div>
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Series</th>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Min (stored)</th>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Max (stored)</th>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Std dev (stored)</th>
          </tr>
        </thead>
        <tbody>
          {% if summary.daily_income_min is not none and summary.daily_income_max is not none and summary.daily_income_std is not none %}
            <tr>
              <td style="padding:6px 0;">Daily income</td>
              <td style="padding:6px 0;">{{ summary.daily_income_min|money(summary.currency) }}</td>
              <td style="padding:6px 0;">{{ summary.daily_income_max|money(summary.currency) }}</td>
              <td style="padding:6px 0;">{{ summary.daily_income_std|money(summary.currency) }}</td>
            </tr>
          {% endif %}
          {% if summary.daily_expense_min is not none and summary.daily_expense_max is not none and summary.daily_expense_std is not none %}
            <tr>
              <td style="padding:6px 0;">Daily expense</td>
              <td style="padding:6px 0;">{{ summary.daily_expense_min|money(summary.currency) }}</td>
              <td style="padding:6px 0;">{{ summary.daily_expense_max|money(summary.currency) }}</td>
              <td style="padding:6px 0;">{{ summary.daily_expense_std|money(summary.currency) }}</td>
            </tr>
          {% endif %}
          {% if summary.daily_net_min is not none and summary.daily_net_max is not none and summary.daily_net_std is not none %}
            <tr>
              <td style="padding:6px 0;">Daily net</td>
              <td style="padding:6px 0;">{{ summary.daily_net_min|money(summary.currency) }}</td>
              <td style="padding:6px 0;">{{ summary.daily_net_max|money(summary.currency) }}</td>
              <td style="padding:6px 0;">{{ summary.daily_net_std|money(summary.currency) }}</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Observed distribution (stored at run time)</h2>
      {% if summary.concentration_top_n is not none and summary.concentration_expense_denominator is not none %}
        <div class="small" style="margin-top:6px; color:var(--muted);">
          Top {{ summary.concentration_top_n }} by share of total window expense (denominator: {{ summary.concentration_expense_denominator|money(summary.currency) }}).
        </div>
      {% endif %}
      <div class="row" style="margin-top:10px;">
        <div class="pill">Vendors (stored)</div>
      </div>
      {% if summary.concentration_top_vendors_expense and summary.concentration_top_vendors_expense|length > 0 %}
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Vendor</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Amount (stored)</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Share (stored)</th>
            </tr>
          </thead>
          <tbody>
            {% for v in summary.concentration_top_vendors_expense %}
              <tr>
                <td style="padding:6px 0;">
                  {%- set vendor_name = v.counterparty|string|trim -%}
                  {%- if vendor_name == '' or vendor_name|lower == 'nan' or vendor_name|lower == 'none' or vendor_name|lower == 'null' -%}
                    <span style="color:var(--muted); font-style:italic;">(No vendor recorded)</span>
                  {%- else -%}
                    {{ vendor_name|redact_vendor(access_role) }}
                  {%- endif -%}
                </td>
                <td style="padding:6px 0;">{{ v.amount|money(summary.currency) }}</td>
                <td style="padding:6px 0;">{{ v.share|pct }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="margin-top:6px; color:var(--muted);">No stored vendor distribution rows for this run.</div>
      {% endif %}

      <div class="row" style="margin-top:12px;">
        <div class="pill">Categories (stored)</div>
      </div>
      {% if summary.concentration_top_categories_expense and summary.concentration_top_categories_expense|length > 0 %}
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Category</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Amount (stored)</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Share (stored)</th>
            </tr>
          </thead>
          <tbody>
            {% for c in summary.concentration_top_categories_expense %}
              <tr>
                <td style="padding:6px 0;">
                  {%- set category_name = c.category|string|trim -%}
                  {%- if category_name == '' or category_name|lower == 'nan' or category_name|lower == 'none' or category_name|lower == 'null' -%}
                    <span style="color:var(--muted); font-style:italic;">(No category recorded)</span>
                  {%- else -%}
                    {{ category_name }}
                  {%- endif -%}
                </td>
                <td style="padding:6px 0;">{{ c.amount|money(summary.currency) }}</td>
                <td style="padding:6px 0;">{{ c.share|pct }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="margin-top:6px; color:var(--muted);">No stored category distribution rows for this run.</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Alerts (stored details)</h2>
      <p class="sub" style="margin-top:6px;">Each alert shows stored fields and status records for this run.</p>
      {% if not can_update %}
        <div class="callout">Status updates are disabled because this is a historical run (read-only).</div>
      {% endif %}
      <div class="hr"></div>

      {% if alerts|length == 0 %}
        <div class="callout">
          <strong>No alerts were triggered for this run.</strong>
          <div style="margin-top:6px;">
            The absence of alerts does not indicate business health or data accuracy.
            Some checks may not have been evaluated if required data was missing.
          </div>
        </div>
      {% else %}
        <div class="grid">
          {% for a in alerts %}
            <div class="alert alert-compact">
              <div class="row" style="align-items:flex-start; gap:14px;">
                <div class="badge {{ 'crit' if a.severity=='critical' else ('warn' if a.severity=='warning' else 'info') }}">{{ a.severity|upper }}</div>
                <div class="meta">
                  <p class="title">{{ a.title }}</p>
                  <p class="why">{{ a.why }}</p>
                  <div class="row" style="margin-top:6px; flex-wrap:wrap;">
                    <div class="pill dim">Status (stored): {{ a._status|capitalize }}</div>
                    {% if a._updated_at %}<div class="pill dim">Updated (stored): {{ a._updated_at|humandt }}</div>{% endif %}
                  </div>
                  <div style="margin-top:8px;">
                    <a class="link" href="/alerts/{{ a.id }}{{ run_qs if run_qs is defined else '' }}">Open</a>
                  </div>
                </div>
              </div>

              <details style="margin-top:10px;">
                <summary style="cursor:pointer; font-weight:900;">Update status (stored)</summary>
                <div style="height:8px;"></div>
                {% if can_update and access_role in ['operator', 'manager', 'admin'] %}
                <form method="post" action="/run/{{ run_id }}/feedback" class="status-form">
                  {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
                  <input type="hidden" name="alert_id" value="{{ a.id }}">
                  <div class="field">
                    <label>Status</label>
                    <select name="status">
                      {% for opt in ['review','noted','acknowledged','ignore','snoozed'] %}
                        <option value="{{ opt }}" {{ 'selected' if a._status==opt else '' }}>{{ opt|capitalize }}</option>
                      {% endfor %}
                    </select>
                    <div class="small" style="color:var(--muted); font-size:12px; margin-top:6px;">
                      Status is a stored workflow label. It does not change calculations or alert evaluation.
                    </div>
                    <div class="small" style="color:var(--muted); font-size:12px; margin-top:4px;">
                      Changes are recorded when you click Record status.
                    </div>
                  </div>
                  <div class="field" style="margin-top:10px;">
                    <label>Note</label>
                    <textarea name="note" class="note-textarea js-autosize" placeholder="Optional note (stored)">{{ a._note }}</textarea>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button class="btn btn-primary" type="submit">Record status</button>
                  </div>
                  <div class="small" style="color:var(--muted); font-size:12px; margin-top:6px;">
                    Button enables when status or note changes.
                  </div>
                  <div class="row" style="margin-top:10px; flex-wrap:wrap;">
                    <div class="pill dim">Signal band (stored): {{ a.signal_strength }}</div>
                    {% if a.suppressed and a.suppression_reason %}
                      <div class="pill dim">Suppressed (stored): {{ a.suppression_reason }}</div>
                    {% elif a.suppressed %}
                      <div class="pill dim">Suppressed (stored)</div>
                    {% endif %}
                    {% if a.quality_context and a.quality_context.score is not none %}
                      <div class="pill dim">
                        Data completeness (stored): {{ '%.0f'|format(a.quality_context.score) }}/100
                        {% if a.quality_context.threshold is not none %}
                          (threshold {{ a.quality_context.threshold }})
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </form>
                {% else %}
                <div style="padding:12px; background:var(--bg-dim); border-radius:var(--radius-sm); color:var(--muted);">
                  <div style="font-weight:700; margin-bottom:6px;">Status (stored): {{ a._status|capitalize }}</div>
                  <div style="font-size:13px; margin-bottom:8px;">Last updated: {{ a._updated_at|humandt if a._updated_at else 'Not recorded' }}</div>
                  {% if a._note and a._note.strip() %}
                  <div style="font-weight:700; margin-top:12px; margin-bottom:4px;">Note (stored):</div>
                  <div style="font-size:13px; margin-bottom:8px; white-space:pre-wrap;">{{ a._note }}</div>
                  {% endif %}
                  <div style="font-size:13px;">This status is read-only for your role or because this is a stored snapshot.</div>
                </div>
                <div class="row" style="margin-top:10px; flex-wrap:wrap;">
                  <div class="pill dim">Signal band (stored): {{ a.signal_strength }}</div>
                  {% if a.suppressed and a.suppression_reason %}
                    <div class="pill dim">Suppressed (stored): {{ a.suppression_reason }}</div>
                  {% elif a.suppressed %}
                    <div class="pill dim">Suppressed (stored)</div>
                  {% endif %}
                  {% if a.quality_context and a.quality_context.score is not none %}
                    <div class="pill dim">
                      Data completeness (stored): {{ '%.0f'|format(a.quality_context.score) }}/100
                      {% if a.quality_context.threshold is not none %}
                        (threshold {{ a.quality_context.threshold }})
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
                {% endif %}
              </details>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
  {% if can_update %}
    <script>
      (function() {
        var forms = document.querySelectorAll('.status-form');
        if (!forms.length) return;
        forms.forEach(function(form) {
          var select = form.querySelector('select[name="status"]');
          var note = form.querySelector('textarea[name="note"]');
          var btn = form.querySelector('button[type="submit"]');
          if (!select || !note || !btn) return;
          var initialStatus = select.value;
          var initialNote = note.value;
          function toggle() {
            var changed = (select.value !== initialStatus) || (note.value !== initialNote);
            btn.disabled = !changed;
          }
          select.addEventListener('change', toggle);
          note.addEventListener('input', toggle);
          toggle();
        });
      })();
    </script>
  {% endif %}

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2 id="checks-not-evaluated">Checks not evaluated (run-time snapshot)</h2>
      <p class="sub" style="margin-top:6px;">Per-rule reasons why checks were not run or did not fire, recorded at analysis time. See <a class="link" href="/settings{{ run_qs if run_qs is defined else '' }}">Settings</a> for configured thresholds.</p>
      <div class="hr"></div>
      {% if summary.non_trigger_explainability and summary.non_trigger_explainability|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>Rule</th>
              <th>Reason</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for r in summary.non_trigger_explainability %}
              <tr>
                <td style="font-weight:800;">{{ r.rule_name }}</td>
                <td>{{ r.reason|replace('_',' ')|title }}</td>
                <td>
                  {% if r.reason == "suppressed" %}
                    {% if r.suppression_reason %}{{ r.suppression_reason }}{% endif %}
                  {% elif r.reason == "missing_data" %}
                    Missing: {{ r.missing_gates|join(", ") }}
                  {% elif r.reason == "threshold_not_crossed" %}
                    Threshold not crossed{% if r.threshold is defined and r.threshold is not none %} (threshold: {{ r.threshold }}){% endif %}{% if r.actual is defined and r.actual is not none %}, actual: {{ r.actual }}{% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="color:var(--muted);">No non-trigger data recorded for this run (field may not have been populated).</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Data completeness (stored)</h2>
      <div class="small" style="color:var(--muted); margin-top:4px;">
        Stored score, band, and coverage fields for this run.
        Bands are derived from score thresholds: Good (≥80), Moderate (≥50), Poor (&lt;50).
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="pill">Completeness indicator (stored): <strong>{{ '%.0f'|format(quality.score or 0) }}/100</strong></div>
        {% if quality.band %}
          <div class="pill dim">Completeness band (stored): {{ quality.band }}</div>
        {% endif %}
        <div class="pill dim">Rows (stored): {{ quality.window_rows }} (window), {{ quality.total_rows }} (total)</div>
        <div class="pill dim">Days covered (stored): {{ quality.window_days_covered }}</div>
      </div>

      {# P1-U3: Data Quality Indicators - Display stored quality metrics and flags #}
      {% if quality.uncategorised_share is not none or quality.unknown_vendor_share is not none or quality.dup_rate is not none %}
      <div class="hr"></div>
      <div style="font-weight:900; margin-bottom:8px;">Data composition (stored)</div>
      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <tbody>
          {% if quality.uncategorised_share is not none %}
          <tr>
            <td style="padding:6px 0; width:50%;">Uncategorised transactions</td>
            <td style="padding:6px 0; text-align:right; font-family:var(--font-mono);">{{ (quality.uncategorised_share * 100)|num(1) }}%</td>
          </tr>
          {% endif %}
          {% if quality.unknown_vendor_share is not none %}
          <tr>
            <td style="padding:6px 0;">Unknown counterparties</td>
            <td style="padding:6px 0; text-align:right; font-family:var(--font-mono);">{{ (quality.unknown_vendor_share * 100)|num(1) }}%</td>
          </tr>
          {% endif %}
          {% if quality.dup_rate is not none %}
          <tr>
            <td style="padding:6px 0;">Duplicate-like rows</td>
            <td style="padding:6px 0; text-align:right; font-family:var(--font-mono);">{{ (quality.dup_rate * 100)|num(1) }}%</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
      {% endif %}

      {% if quality.validation_gates and quality.validation_gates|length > 0 %}
      <div class="hr"></div>
      <div style="font-weight:900; margin-bottom:8px;">Field detection (stored)</div>
      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <tbody>
          {% for gate in quality.validation_gates %}
          <tr>
            <td style="padding:6px 0;">{{ gate.gate|replace('_', ' ')|title }}</td>
            <td style="padding:6px 0; text-align:right;">
              {% if gate.passed %}
                <span style="color:var(--success, #059669);">✓ Present</span>
              {% else %}
                <span style="color:var(--muted);">— Not detected</span>
                {% if gate.missing and gate.missing|length > 0 %}
                  <span style="font-size:11px; color:var(--muted);"> ({{ gate.missing|join(', ') }})</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      {% if quality.flags and quality.flags|length > 0 %}
      <div class="hr"></div>
      <div style="font-weight:900; margin-bottom:8px;">Data notes (stored)</div>
      <ul style="margin:0; padding-left:20px; font-size:13px; color:var(--muted);">
        {% for flag in quality.flags %}
        <li style="margin-bottom:4px;">{{ flag }}</li>
        {% endfor %}
      </ul>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        These are descriptive notes about data characteristics. They do not indicate errors or require action.
      </div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Schema &amp; mapping (stored)</h2>
      <div class="hr"></div>
      {% if params and params.ledger_contract %}
        <div class="row">
          {% if params.ledger_contract.schema_version %}
            <div class="pill">Schema (stored): {{ params.ledger_contract.schema_version }}</div>
          {% endif %}
          {% if params.ledger_contract.adapter_version %}
            <div class="pill dim">Adapter (stored): {{ params.ledger_contract.adapter_version }}</div>
          {% endif %}
          {% if params.ledger_contract.row_count is not none %}
            <div class="pill dim">Rows (stored): {{ params.ledger_contract.row_count }}</div>
          {% endif %}
        </div>
        {% if params.ledger_contract.columns_present %}
          <div class="small" style="margin-top:10px; color:#334155;">
            Columns present: {{ params.ledger_contract.columns_present|join(", ") }}
          </div>
        {% endif %}
        {% if params.normalization and params.normalization.required_column_mapping %}
          <div style="margin-top:10px;">
            <div style="font-weight:900; margin-bottom:6px;">Required column mapping</div>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Canonical</th>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Source</th>
                </tr>
              </thead>
              <tbody>
                {% for k, v in params.normalization.required_column_mapping.items() %}
                  <tr>
                    <td style="padding:6px 0;">{{ k }}</td>
                    <td style="padding:6px 0;">{{ v if v is not none else '' }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% else %}
        <div class="small" style="color:var(--muted);">Schema metadata not available for this run.</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Provenance (stored at run time)</h2>
      <div class="hr"></div>
      {% if params %}
        <div class="row">
          {% if params.config_version %}
            <div class="pill">Config version (stored): {{ params.config_version }}</div>
          {% endif %}
          {% if params.migration_policy %}
            <div class="pill dim">Migration policy (stored): {{ params.migration_policy }}</div>
          {% endif %}
        </div>
        {% if params.source is defined and (params.source.provider or params.source.mode) %}
          <div class="small" style="margin-top:8px; color:#334155;">
            {% if params.source.provider %}Source (stored): {{ params.source.provider }}{% endif %}
            {% if params.source.mode %} • Mode (stored): {{ params.source.mode }}{% endif %}
          </div>
        {% endif %}
        {% if params.source is defined and (params.source.filename or params.source.ingest_id) %}
          <div class="small" style="margin-top:6px; color:#334155;">
            {% if params.source.filename %}Source filename (stored): {{ params.source.filename }}{% endif %}
            {% if params.source.ingest_id %} • Ingest ID (stored): {{ params.source.ingest_id }}{% endif %}
          </div>
        {% endif %}
      {% else %}
        <div class="small" style="color:var(--muted);">Provenance metadata not available for this run.</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <details>
    <summary style="cursor:pointer; font-weight:900;">Developer details (fields &amp; hashes)</summary>
    <div style="height:10px;"></div>
    <div class="card">
      <div class="card-b">
        <h2>Hashes (stored)</h2>
        <div class="hr"></div>
        {% if params %}
          <div class="row">
            {% if params.config_hash %}
              <div class="pill dim">Config hash (stored): {{ params.config_hash }}</div>
            {% endif %}
            {% if params.code_hash %}
              <div class="pill dim">Code hash (stored): {{ params.code_hash }}</div>
            {% endif %}
          </div>
          <div class="row" style="margin-top:8px;">
            <div class="pill dim">Rule inventory hash (run-time snapshot): {{ params.rule_inventory_hash if params.rule_inventory_hash else 'Not recorded' }}</div>
          </div>
          <div class="row" style="margin-top:8px;">
            {% if params.artifact_ids is defined and params.artifact_ids.report_id %}
              <div class="pill dim">Report ID (stored): {{ params.artifact_ids.report_id }}</div>
            {% endif %}
            {% if params.artifact_ids is defined and params.artifact_ids.snapshot_id %}
              <div class="pill dim">Snapshot ID (stored): {{ params.artifact_ids.snapshot_id }}</div>
            {% endif %}
          </div>
        {% else %}
          <div class="small" style="color:var(--muted);">Hash metadata not available for this run.</div>
        {% endif %}
      </div>
    </div>

    <div style="height:14px;"></div>

    <div class="card">
      <div class="card-b">
        <h2>Evidence index (stored at run time)</h2>
        <div class="small" style="margin-top:6px; color:var(--muted);">
          Each panel below lists the stored fields shown on this page for this run.
        </div>
        <div class="hr"></div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Panel</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Stored fields</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Run header</td>
              <td style="padding:6px 0;">
                <span class="mono">run_id</span>,
                <span class="mono">created_at</span>,
                <span class="mono">filename</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">KPIs</td>
              <td style="padding:6px 0;">
                <span class="mono">summary.current_cash</span>,
                <span class="mono">summary.runway_days</span>,
                <span class="mono">summary.recent_income</span>,
                <span class="mono">summary.recent_expense</span>,
                <span class="mono">summary.income_change</span>,
                <span class="mono">summary.expense_change</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Window totals</td>
              <td style="padding:6px 0;">
                <span class="mono">summary.window_start_date</span>,
                <span class="mono">summary.end_date</span>,
                <span class="mono">summary.window_income</span>,
                <span class="mono">summary.window_expense</span>,
                <span class="mono">summary.window_net_change</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Coverage</td>
              <td style="padding:6px 0;">
                <span class="mono">summary.window_transaction_count</span>,
                <span class="mono">summary.window_days_observed</span>,
                <span class="mono">summary.window_days_span_inclusive</span>,
                <span class="mono">summary.window_days_with_income</span>,
                <span class="mono">summary.window_days_with_expense</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Observed distribution</td>
              <td style="padding:6px 0;">
                <span class="mono">summary.concentration_top_n</span>,
                <span class="mono">summary.concentration_expense_denominator</span>,
                <span class="mono">summary.concentration_top_vendors_expense</span>,
                <span class="mono">summary.concentration_top_categories_expense</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Run‑to‑run change ledger</td>
              <td style="padding:6px 0;">
                <span class="mono">summary.run_to_run</span>
                (prior_run_id, prior_created_at, fields[])
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Observed variability</td>
              <td style="padding:6px 0;">
                <span class="mono">summary.daily_income_min</span>,
                <span class="mono">summary.daily_income_max</span>,
                <span class="mono">summary.daily_income_std</span>,
                <span class="mono">summary.daily_expense_min</span>,
                <span class="mono">summary.daily_expense_max</span>,
                <span class="mono">summary.daily_expense_std</span>,
                <span class="mono">summary.daily_net_min</span>,
                <span class="mono">summary.daily_net_max</span>,
                <span class="mono">summary.daily_net_std</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Alerts</td>
              <td style="padding:6px 0;">
                <span class="mono">alerts[]</span>
                (stored alerts with status and evidence)
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Non‑trigger reasons</td>
              <td style="padding:6px 0;">
                <span class="mono">summary.non_trigger_explainability</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Data completeness</td>
              <td style="padding:6px 0;">
                <span class="mono">quality.score</span>,
                <span class="mono">quality.band</span>,
                <span class="mono">quality.window_rows</span>,
                <span class="mono">quality.total_rows</span>,
                <span class="mono">quality.window_days_covered</span>,
                <span class="mono">quality.flags</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Schema &amp; mapping</td>
              <td style="padding:6px 0;">
                <span class="mono">params.ledger_contract</span>,
                <span class="mono">params.normalization.required_column_mapping</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Audit metadata</td>
              <td style="padding:6px 0;">
                <span class="mono">params.config_version</span>,
                <span class="mono">params.config_hash</span>,
                <span class="mono">params.code_hash</span>,
                <span class="mono">params.rule_inventory_hash</span>,
                <span class="mono">params.source.ingest_id</span>
              </td>
            </tr>
            <tr>
              <td style="padding:6px 0; font-weight:800;">Normalization log</td>
              <td style="padding:6px 0;">
                <span class="mono">params.normalization</span>
                (rows_in/out, duplicates, renames)
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="height:14px;"></div>

    <div class="card">
      <div class="card-b">
        <h2>Audit metadata (stored)</h2>
        <div class="hr"></div>
        {% if params %}
          <div class="row">
            {% if params.config_version %}
              <div class="pill">Config version: {{ params.config_version }}</div>
            {% endif %}
            {% if params.config_hash %}
              <div class="pill dim">Config hash: {{ params.config_hash }}</div>
            {% endif %}
          </div>
          <div class="row" style="margin-top:8px;">
            {% if params.code_hash %}
              <div class="pill dim">Code hash: {{ params.code_hash }}</div>
            {% endif %}
            <div class="pill dim">Rule inventory hash (run-time snapshot): {{ params.rule_inventory_hash if params.rule_inventory_hash else 'Not recorded' }}</div>
          </div>
          {% if params.source is defined and params.source.ingest_id %}
            <div class="small" style="margin-top:8px; color:#334155;">
              Ingest ID: {{ params.source.ingest_id }}
            </div>
          {% endif %}
        {% else %}
          <div class="small" style="color:var(--muted);">Audit metadata not available for this run.</div>
        {% endif %}
      </div>
    </div>
  </details>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Normalization log (stored)</h2>
      <div class="hr"></div>
      {% if params and params.normalization %}
        <div class="row">
          {% if params.normalization.rows_input is not none %}
            <div class="pill">Rows in: {{ params.normalization.rows_input }}</div>
          {% endif %}
          {% if params.normalization.rows_output is not none %}
            <div class="pill dim">Rows out: {{ params.normalization.rows_output }}</div>
          {% endif %}
          {% if params.normalization.rows_dropped_missing_date is not none %}
            <div class="pill dim">Dropped (missing date): {{ params.normalization.rows_dropped_missing_date }}</div>
          {% endif %}
        </div>
        <div class="row" style="margin-top:8px;">
          {% if params.normalization.duplicates_dropped is not none %}
            <div class="pill dim">Duplicates dropped: {{ params.normalization.duplicates_dropped }}</div>
          {% endif %}
          {% if params.normalization.amount_parse_invalid is not none %}
            <div class="pill dim">Amount parse invalid: {{ params.normalization.amount_parse_invalid }}</div>
          {% endif %}
        </div>
        {% if params.normalization.applied_renames %}
          <div style="margin-top:10px;">
            <div style="font-weight:900; margin-bottom:6px;">Applied renames</div>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">From</th>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">To</th>
                </tr>
              </thead>
              <tbody>
                {% for r in params.normalization.applied_renames %}
                  <tr>
                    <td style="padding:6px 0;">{{ r.from }}</td>
                    <td style="padding:6px 0;">{{ r.to }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
        {% if params.normalization.duplicate_basis %}
          <div class="small" style="margin-top:10px; color:#334155;">
            Duplicate basis: {{ params.normalization.duplicate_basis|join(", ") }}
          </div>
        {% endif %}
      {% else %}
        <div class="small" style="color:var(--muted);">Normalization data not available for this run.</div>
      {% endif %}
    </div>
  </div>
    </div>
  </details>

  <!-- E1: Snapshot Provenance Section -->
  {% if provenance %}
  <details style="margin-top:32px;">
    <summary style="cursor:pointer; font-weight:800; font-size:15px; padding:12px 0;">
      Snapshot Provenance
    </summary>
    <div class="card" style="margin-top:12px;">
      <div class="card-b">
        <p style="margin:0 0 16px 0; color:var(--muted); font-size:14px;">
          This snapshot was generated using fixed rules and stored inputs. Results are repeatable and auditable.
        </p>
        <table style="width:100%; border-collapse:collapse;">
          <tbody>
            <tr>
              <td style="padding:8px 0; font-weight:700; width:200px;">Snapshot ID</td>
              <td style="padding:8px 0; font-family:monospace; font-size:13px;">{{ provenance.snapshot_id }}</td>
            </tr>
            <tr>
              <td style="padding:8px 0; font-weight:700;">Created (UTC)</td>
              <td style="padding:8px 0; font-family:monospace; font-size:13px;">{{ provenance.created_at }}</td>
            </tr>
            <tr>
              <td style="padding:8px 0; font-weight:700;">File Hash (SHA-256)</td>
              <td style="padding:8px 0; font-family:monospace; font-size:11px; word-break:break-all;">{{ provenance.file_sha256 }}</td>
            </tr>
            <tr>
              <td style="padding:8px 0; font-weight:700;">Settings Hash</td>
              <td style="padding:8px 0; font-family:monospace; font-size:11px; word-break:break-all;">{{ provenance.settings_hash }}</td>
            </tr>
            <tr>
              <td style="padding:8px 0; font-weight:700;">Rule Inventory Hash</td>
              <td style="padding:8px 0; font-family:monospace; font-size:11px; word-break:break-all;">{{ provenance.rule_inventory_hash }}</td>
            </tr>
            <tr>
              <td style="padding:8px 0; font-weight:700;">Code Version Hash</td>
              <td style="padding:8px 0; font-family:monospace; font-size:11px; word-break:break-all;">{{ provenance.code_hash }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </details>
  {% endif %}
{% endblock %}
