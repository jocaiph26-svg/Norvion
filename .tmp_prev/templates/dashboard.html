{% extends "base.html" %}
{% block content %}
  <div class="header">
    <div>
      <h1 class="h1">Run {{ run_id }}</h1>
      <p class="sub">{{ filename }} • {{ created_at|humandt }}</p>
      <p class="sub" style="margin-top:6px;">
        Entity (stored at run time): <span class="mono">{{ run_entity_id or "—" }}</span>
      </p>
      {% if authorized_entities %}
        <p class="sub" style="margin-top:6px;">
          Entities in access history (stored): {{ authorized_entities|join(", ") }}
        </p>
      {% endif %}
    </div>
    <div class="row">
      <a class="btn" href="/dashboard{{ run_qs if run_qs is defined else "" }}">Home</a>
      <a class="btn" href="/alerts{{ run_qs if run_qs is defined else "" }}">Alerts</a>
      <a class="btn btn-primary" href="/upload">Upload</a>
    </div>
  </div>

  <div class="grid cols-4">
    <div class="card kpi">
      <div class="label">Current cash</div>
      <div class="value">{{ summary.current_cash|money(summary.currency) }}</div>
      <div class="hint">From uploaded window.</div>
    </div>
    <div class="card kpi">
  <div class="label">Runway</div>
  <div class="value">
    {% if summary.runway_na %}
      N/A
    {% elif summary.runway_days is not none and summary.runway_days <= 0 %}
      Overdrawn
    {% elif summary.runway_days is not none %}
      {{ '%.0f'|format(summary.runway_days) }} days
    {% else %}
      —
    {% endif %}
  </div>
  <div class="hint">
    {% if summary.runway_na %}
      {{ summary.runway_note }}
    {% elif summary.runway_days is not none and summary.runway_days <= 0 %}
      Cash is negative or runway ≤ 0.
    {% elif summary.runway_days is not none %}
      Based on recent burn.
    {% else %}
      —
    {% endif %}
  </div>
</div>

    <div class="card kpi">
      <div class="label">Income change</div>
      <div class="value">{{ summary.income_change|pct }}</div>
      <div class="hint">Recent vs previous.</div>
    </div>
    <div class="card kpi">
      <div class="label">Expense change</div>
      <div class="value">{{ summary.expense_change|pct }}</div>
      <div class="hint">Recent vs previous.</div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Window totals (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Window: {{ summary.window_start_date or "—" }} to {{ summary.end_date or "—" }} (inclusive).
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="pill">Window income (stored): {{ summary.window_income|money(summary.currency) }}</div>
        <div class="pill dim">Window expense (stored): {{ summary.window_expense|money(summary.currency) }}</div>
        <div class="pill dim">Window net change (stored): {{ summary.window_net_change|money(summary.currency) }}</div>
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Coverage (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Distinct dates observed are counted from post-normalization rows within the window.
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="pill">Transactions in window (stored): {{ summary.window_transaction_count if summary.window_transaction_count is not none else "—" }}</div>
        <div class="pill dim">Distinct dates observed (stored): {{ summary.window_days_observed if summary.window_days_observed is not none else "—" }}</div>
        <div class="pill dim">Window span (stored, inclusive): {{ summary.window_days_span_inclusive if summary.window_days_span_inclusive is not none else "—" }}</div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="pill dim">Days with income (stored): {{ summary.window_days_with_income if summary.window_days_with_income is not none else "—" }}</div>
        <div class="pill dim">Days with expense (stored): {{ summary.window_days_with_expense if summary.window_days_with_expense is not none else "—" }}</div>
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Coverage continuity (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Missing dates are counted as inclusive window span minus distinct dates observed.
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="pill">Window span (stored, inclusive): {{ summary.window_days_span_inclusive if summary.window_days_span_inclusive is not none else "—" }}</div>
        <div class="pill dim">Distinct dates observed (stored): {{ summary.window_days_observed if summary.window_days_observed is not none else "—" }}</div>
        <div class="pill dim">Missing dates (stored): {{ summary.window_missing_dates if summary.window_missing_dates is not none else "—" }}</div>
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Observed run snapshot (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Values below are stored for this run and shown without recomputation.
      </div>
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <tbody>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Run</td>
            <td style="padding:6px 0;">
              <span class="mono">run_id</span> {{ run_id }} ·
              <span class="mono">created_at</span> {{ created_at|humandt }} ·
              <span class="mono">filename</span> {{ filename }}
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Window</td>
            <td style="padding:6px 0;">
              <span class="mono">window_start_date</span> {{ summary.window_start_date or "—" }} ·
              <span class="mono">end_date</span> {{ summary.end_date or "—" }} ·
              <span class="mono">window_days_span_inclusive</span> {{ summary.window_days_span_inclusive if summary.window_days_span_inclusive is not none else "—" }}
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Window totals</td>
            <td style="padding:6px 0;">
              <span class="mono">window_income</span> {{ summary.window_income|money(summary.currency) }} ·
              <span class="mono">window_expense</span> {{ summary.window_expense|money(summary.currency) }} ·
              <span class="mono">window_net_change</span> {{ summary.window_net_change|money(summary.currency) }}
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Coverage</td>
            <td style="padding:6px 0;">
              <span class="mono">window_transaction_count</span> {{ summary.window_transaction_count if summary.window_transaction_count is not none else "—" }} ·
              <span class="mono">window_days_observed</span> {{ summary.window_days_observed if summary.window_days_observed is not none else "—" }} ·
              <span class="mono">window_days_with_income</span> {{ summary.window_days_with_income if summary.window_days_with_income is not none else "—" }} ·
              <span class="mono">window_days_with_expense</span> {{ summary.window_days_with_expense if summary.window_days_with_expense is not none else "—" }} ·
              <span class="mono">window_missing_dates</span> {{ summary.window_missing_dates if summary.window_missing_dates is not none else "—" }}
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Data quality</td>
            <td style="padding:6px 0;">
              <span class="mono">quality.score</span> {{ '%.0f'|format(quality.score or 0) }} ·
              <span class="mono">quality.band</span> {{ quality.band or "—" }}
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Observed distribution</td>
            <td style="padding:6px 0;">
              <span class="mono">concentration_top_n</span> {{ summary.concentration_top_n if summary.concentration_top_n is not none else "—" }} ·
              <span class="mono">concentration_expense_denominator</span> {{ summary.concentration_expense_denominator|money(summary.currency) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Run‑to‑run change ledger (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Differences are stored at run creation and shown without recomputation.
      </div>
      {% if summary.run_to_run %}
        <div class="small" style="margin-top:8px; color:#334155;">
          Prior run: <span class="mono">#{{ summary.run_to_run.prior_run_id }}</span> ·
          <span class="mono">{{ summary.run_to_run.prior_created_at|humandt }}</span>
        </div>
        {% set money_fields = [
          "current_cash",
          "window_income",
          "window_expense",
          "window_net_change",
          "recent_income",
          "recent_expense",
          "concentration_expense_denominator"
        ] %}
        {% set pct_fields = ["income_change", "expense_change"] %}
        {% set day_fields = [
          "runway_days",
          "window_days_observed",
          "window_days_span_inclusive",
          "window_days_with_income",
          "window_days_with_expense",
          "window_missing_dates"
        ] %}
        {% set count_fields = ["window_transaction_count"] %}
        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Field</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Current (stored)</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Prior (stored)</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Difference (stored)</th>
            </tr>
          </thead>
          <tbody>
            {% for item in summary.run_to_run.fields %}
              <tr>
                <td style="padding:6px 0;">{{ item.field }}</td>
                <td style="padding:6px 0;">
                  {% if item.current is none %}
                    —
                  {% elif item.field in money_fields %}
                    {{ item.current|money(summary.currency) }}
                  {% elif item.field in pct_fields %}
                    {{ item.current|pct }}
                  {% elif item.field in day_fields %}
                    {{ item.current|num(0) }}
                  {% elif item.field in count_fields %}
                    {{ item.current|num(0) }}
                  {% else %}
                    {{ item.current|num(2) }}
                  {% endif %}
                </td>
                <td style="padding:6px 0;">
                  {% if item.prior is none %}
                    —
                  {% elif item.field in money_fields %}
                    {{ item.prior|money(summary.currency) }}
                  {% elif item.field in pct_fields %}
                    {{ item.prior|pct }}
                  {% elif item.field in day_fields %}
                    {{ item.prior|num(0) }}
                  {% elif item.field in count_fields %}
                    {{ item.prior|num(0) }}
                  {% else %}
                    {{ item.prior|num(2) }}
                  {% endif %}
                </td>
                <td style="padding:6px 0;">
                  {% if item.delta is none %}
                    —
                  {% elif item.field in money_fields %}
                    {{ item.delta|money(summary.currency) }}
                  {% elif item.field in pct_fields %}
                    {{ item.delta|pct }}
                  {% elif item.field in day_fields %}
                    {{ item.delta|num(0) }}
                  {% elif item.field in count_fields %}
                    {{ item.delta|num(0) }}
                  {% else %}
                    {{ item.delta|num(2) }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="margin-top:8px; color:var(--muted);">
          No prior run is available for comparison.
        </div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Observed variability (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Daily min/max/std values are stored for this run and shown without recomputation.
      </div>
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Series</th>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Min (stored)</th>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Max (stored)</th>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Std dev (stored)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding:6px 0;">Daily income</td>
            <td style="padding:6px 0;">{{ summary.daily_income_min|money(summary.currency) }}</td>
            <td style="padding:6px 0;">{{ summary.daily_income_max|money(summary.currency) }}</td>
            <td style="padding:6px 0;">{{ summary.daily_income_std|money(summary.currency) }}</td>
          </tr>
          <tr>
            <td style="padding:6px 0;">Daily expense</td>
            <td style="padding:6px 0;">{{ summary.daily_expense_min|money(summary.currency) }}</td>
            <td style="padding:6px 0;">{{ summary.daily_expense_max|money(summary.currency) }}</td>
            <td style="padding:6px 0;">{{ summary.daily_expense_std|money(summary.currency) }}</td>
          </tr>
          <tr>
            <td style="padding:6px 0;">Daily net</td>
            <td style="padding:6px 0;">{{ summary.daily_net_min|money(summary.currency) }}</td>
            <td style="padding:6px 0;">{{ summary.daily_net_max|money(summary.currency) }}</td>
            <td style="padding:6px 0;">{{ summary.daily_net_std|money(summary.currency) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Observed distribution (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Top {{ summary.concentration_top_n if summary.concentration_top_n is not none else "—" }} by share of total window expense (denominator: {{ summary.concentration_expense_denominator|money(summary.currency) }}).
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="pill">Vendors (stored)</div>
      </div>
      {% if summary.concentration_top_vendors_expense and summary.concentration_top_vendors_expense|length > 0 %}
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Vendor</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Amount (stored)</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Share (stored)</th>
            </tr>
          </thead>
          <tbody>
            {% for v in summary.concentration_top_vendors_expense %}
              <tr>
                <td style="padding:6px 0;">{{ v.counterparty }}</td>
                <td style="padding:6px 0;">{{ v.amount|money(summary.currency) }}</td>
                <td style="padding:6px 0;">{{ v.share|pct }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="margin-top:6px; color:var(--muted);">—</div>
      {% endif %}

      <div class="row" style="margin-top:12px;">
        <div class="pill">Categories (stored)</div>
      </div>
      {% if summary.concentration_top_categories_expense and summary.concentration_top_categories_expense|length > 0 %}
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Category</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Amount (stored)</th>
              <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Share (stored)</th>
            </tr>
          </thead>
          <tbody>
            {% for c in summary.concentration_top_categories_expense %}
              <tr>
                <td style="padding:6px 0;">{{ c.category }}</td>
                <td style="padding:6px 0;">{{ c.amount|money(summary.currency) }}</td>
                <td style="padding:6px 0;">{{ c.share|pct }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="margin-top:6px; color:var(--muted);">—</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Alerts</h2>
      <p class="sub" style="margin-top:6px;">Each alert includes suggested actions and evidence. Use the status dropdown to reduce noise and keep an audit trail.</p>
      <div class="hr"></div>

      {% if alerts|length == 0 %}
        <div class="callout">No alerts triggered in this run.</div>
      {% else %}
        <div class="grid">
          {% for a in alerts %}
            <div class="alert">
              <div class="badge {{ 'crit' if a.severity=='critical' else ('warn' if a.severity=='warning' else 'info') }}">{{ a.severity|upper }}</div>
              <div class="meta">
                <p class="title">{{ a.title }}</p>
                <p class="why">{{ a.why }}</p>
                <div class="pills">
                  <div class="pill dim">Signal: {{ a.signal_strength }}</div>
                  <div class="pill dim">Status: {{ a._status|capitalize }}</div>
                  {% if a.suppressed %}
                    <div class="pill dim">Suppressed: low data quality</div>
                  {% endif %}
                  {% if a.quality_context %}
                    <div class="pill dim">Data quality: {{ '%.0f'|format(a.quality_context.score if a.quality_context.score is not none else 0) }}/100 (threshold {{ a.quality_context.threshold if a.quality_context.threshold is not none else '—' }})</div>
                  {% endif %}
                  {% if a._updated_at %}<div class="pill dim">Updated: {{ a._updated_at|humandt }}</div>{% endif %}
                </div>
                {% if a.suggested_actions %}
                  <div style="margin-top:10px; color:#334155;">
                    <div style="font-weight:900; margin-bottom:6px;">Suggested actions</div>
                    <ul style="margin:0; padding-left:18px;">
                      {% for s in a.suggested_actions %}
                        <li style="margin:6px 0;">{{ s }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              </div>

              <div class="right" style="flex-direction:column; align-items:stretch; gap:10px; min-width:240px;">
                <form method="post" action="/run/{{ run_id }}/feedback">
                  <input type="hidden" name="alert_id" value="{{ a.id }}">
                  <div class="field">
                    <label>Status</label>
                    <select name="status">
                      {% for opt in ['review','expected','actioned','ignore','snoozed'] %}
                        <option value="{{ opt }}" {{ 'selected' if a._status==opt else '' }}>{{ opt|capitalize }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="field" style="margin-top:10px;">
                    <label>Note</label>
                    <textarea name="note" placeholder="Optional manager note...">{{ a._note }}</textarea>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button class="btn btn-primary" type="submit">Save</button>
                    <a class="btn btn-sm" href="/alerts/{{ a.id }}">Details</a>
                  </div>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Why checks did not trigger</h2>
      <p class="sub" style="margin-top:6px;">Per-rule non-trigger reasons for this run.</p>
      <div class="hr"></div>
      {% if summary.non_trigger_explainability and summary.non_trigger_explainability|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>Rule</th>
              <th>Reason</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for r in summary.non_trigger_explainability %}
              <tr>
                <td style="font-weight:800;">{{ r.rule_name }}</td>
                <td>{{ r.reason }}</td>
                <td>
                  {% if r.reason == "suppressed" %}
                    {{ r.suppression_reason }}
                  {% elif r.reason == "missing_data" %}
                    Missing: {{ r.missing_gates|join(", ") }}
                  {% elif r.reason == "threshold_not_crossed" %}
                    Threshold not crossed
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="small" style="color:var(--muted);">No non-trigger explanations are available for this run.</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Data quality</h2>
      <div class="hr"></div>
      <div class="row">
        <div class="pill">Score: <strong>{{ '%.0f'|format(quality.score or 0) }}/100</strong></div>
        <div class="small" style="color:var(--muted); margin-top:4px;">
          {% if quality.score is not none %}
            This score reflects the completeness and coverage of the uploaded data. Higher scores reflect greater data completeness. A score of 100 reflects fully complete data for the checks performed; lower scores may reflect missing or partial fields.<br>
            {% if quality.score >= 90 %}High completeness
            {% elif quality.score >= 70 %}Moderate completeness
            {% elif quality.score >= 50 %}Partial completeness
            {% else %}Limited data coverage
            {% endif %}
          {% else %}
            Data quality information is not available for this run.
          {% endif %}
        </div>
        <div class="pill dim">Rows: {{ quality.window_rows }} (window), {{ quality.total_rows }} (total)</div>
        <div class="pill dim">Days covered: {{ quality.window_days_covered }}</div>
      </div>
      {% if quality.flags %}
        <div style="margin-top:10px;">
          <ul style="margin:0; padding-left:18px; color:#334155;">
            {% for f in quality.flags %}
              <li style="margin:6px 0;">{{ f }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Schema &amp; mapping</h2>
      <div class="hr"></div>
      {% if params and params.ledger_contract %}
        <div class="row">
          <div class="pill">Schema: {{ params.ledger_contract.schema_version or "—" }}</div>
          <div class="pill dim">Adapter: {{ params.ledger_contract.adapter_version or "—" }}</div>
          <div class="pill dim">Rows: {{ params.ledger_contract.row_count or "—" }}</div>
        </div>
        {% if params.ledger_contract.columns_present %}
          <div class="small" style="margin-top:10px; color:#334155;">
            Columns present: {{ params.ledger_contract.columns_present|join(", ") }}
          </div>
        {% endif %}
        {% if params.normalization and params.normalization.required_column_mapping %}
          <div style="margin-top:10px;">
            <div style="font-weight:900; margin-bottom:6px;">Required column mapping</div>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Canonical</th>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Source</th>
                </tr>
              </thead>
              <tbody>
                {% for k, v in params.normalization.required_column_mapping.items() %}
                  <tr>
                    <td style="padding:6px 0;">{{ k }}</td>
                    <td style="padding:6px 0;">{{ v if v else "—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% else %}
        <div class="small" style="color:var(--muted);">Schema metadata not available for this run.</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Provenance (stored at run time)</h2>
      <div class="hr"></div>
      {% if params %}
        <div class="row">
          <div class="pill">Config version (stored): {{ params.config_version or "—" }}</div>
          <div class="pill dim">Migration policy (stored): {{ params.migration_policy or "—" }}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="pill dim">Config hash (stored): {{ params.config_hash or "—" }}</div>
          <div class="pill dim">Code hash (stored): {{ params.code_hash or "—" }}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="pill dim">Rule inventory hash (stored): {{ params.rule_inventory_hash or "—" }}</div>
          <div class="pill dim">Rule inventory version (stored): {{ params.rule_inventory_version or "—" }}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="pill dim">Report ID (stored): {{ params.artifact_ids.report_id if params.artifact_ids is defined else "—" }}</div>
          <div class="pill dim">Snapshot ID (stored): {{ params.artifact_ids.snapshot_id if params.artifact_ids is defined else "—" }}</div>
        </div>
        <div class="small" style="margin-top:8px; color:#334155;">
          Source (stored): {{ (params.source.provider if params.source is defined else None) or "—" }}
          • Mode (stored): {{ (params.source.mode if params.source is defined else None) or "—" }}
        </div>
        <div class="small" style="margin-top:6px; color:#334155;">
          Source filename (stored): {{ (params.source.filename if params.source is defined else None) or "—" }}
          • Ingest ID (stored): {{ (params.source.ingest_id if params.source is defined else None) or "—" }}
        </div>
      {% else %}
        <div class="small" style="color:var(--muted);">Provenance metadata not available for this run.</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Evidence index (stored at run time)</h2>
      <div class="small" style="margin-top:6px; color:var(--muted);">
        Each panel below lists the stored fields shown on this page for this run.
      </div>
      <div class="hr"></div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Panel</th>
            <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Stored fields</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Run header</td>
            <td style="padding:6px 0;">
              <span class="mono">run_id</span>,
              <span class="mono">created_at</span>,
              <span class="mono">filename</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">KPIs</td>
            <td style="padding:6px 0;">
              <span class="mono">summary.current_cash</span>,
              <span class="mono">summary.runway_days</span>,
              <span class="mono">summary.income_change</span>,
              <span class="mono">summary.expense_change</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Window totals</td>
            <td style="padding:6px 0;">
              <span class="mono">summary.window_start_date</span>,
              <span class="mono">summary.end_date</span>,
              <span class="mono">summary.window_income</span>,
              <span class="mono">summary.window_expense</span>,
              <span class="mono">summary.window_net_change</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Coverage</td>
            <td style="padding:6px 0;">
              <span class="mono">summary.window_transaction_count</span>,
              <span class="mono">summary.window_days_observed</span>,
              <span class="mono">summary.window_days_span_inclusive</span>,
              <span class="mono">summary.window_days_with_income</span>,
              <span class="mono">summary.window_days_with_expense</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Observed distribution</td>
            <td style="padding:6px 0;">
              <span class="mono">summary.concentration_top_n</span>,
              <span class="mono">summary.concentration_expense_denominator</span>,
              <span class="mono">summary.concentration_top_vendors_expense</span>,
              <span class="mono">summary.concentration_top_categories_expense</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Run‑to‑run change ledger</td>
            <td style="padding:6px 0;">
              <span class="mono">summary.run_to_run</span>
              (prior_run_id, prior_created_at, fields[])
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Observed variability</td>
            <td style="padding:6px 0;">
              <span class="mono">summary.daily_income_min</span>,
              <span class="mono">summary.daily_income_max</span>,
              <span class="mono">summary.daily_income_std</span>,
              <span class="mono">summary.daily_expense_min</span>,
              <span class="mono">summary.daily_expense_max</span>,
              <span class="mono">summary.daily_expense_std</span>,
              <span class="mono">summary.daily_net_min</span>,
              <span class="mono">summary.daily_net_max</span>,
              <span class="mono">summary.daily_net_std</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Alerts</td>
            <td style="padding:6px 0;">
              <span class="mono">alerts[]</span>
              (stored alerts with status and evidence)
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Non‑trigger reasons</td>
            <td style="padding:6px 0;">
              <span class="mono">summary.non_trigger_explainability</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Data quality</td>
            <td style="padding:6px 0;">
              <span class="mono">quality.score</span>,
              <span class="mono">quality.band</span>,
              <span class="mono">quality.window_rows</span>,
              <span class="mono">quality.total_rows</span>,
              <span class="mono">quality.window_days_covered</span>,
              <span class="mono">quality.flags</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Schema &amp; mapping</td>
            <td style="padding:6px 0;">
              <span class="mono">params.ledger_contract</span>,
              <span class="mono">params.normalization.required_column_mapping</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Audit metadata</td>
            <td style="padding:6px 0;">
              <span class="mono">params.config_version</span>,
              <span class="mono">params.config_hash</span>,
              <span class="mono">params.code_hash</span>,
              <span class="mono">params.rule_inventory_hash</span>,
              <span class="mono">params.source.ingest_id</span>
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0; font-weight:800;">Normalization log</td>
            <td style="padding:6px 0;">
              <span class="mono">params.normalization</span>
              (rows_in/out, duplicates, renames)
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Audit metadata</h2>
      <div class="hr"></div>
      {% if params %}
        <div class="row">
          <div class="pill">Config version: {{ params.config_version or "—" }}</div>
          <div class="pill dim">Config hash: {{ params.config_hash or "—" }}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="pill dim">Code hash: {{ params.code_hash or "—" }}</div>
          <div class="pill dim">Rule inventory hash: {{ params.rule_inventory_hash or "—" }}</div>
        </div>
        <div class="small" style="margin-top:8px; color:#334155;">
          Ingest ID: {{ (params.source.ingest_id if params.source is defined else None) or "—" }}
        </div>
      {% else %}
        <div class="small" style="color:var(--muted);">Audit metadata not available for this run.</div>
      {% endif %}
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div class="card-b">
      <h2>Normalization log</h2>
      <div class="hr"></div>
      {% if params and params.normalization %}
        <div class="row">
          <div class="pill">Rows in: {{ params.normalization.rows_input if params.normalization.rows_input is not none else '—' }}</div>
          <div class="pill dim">Rows out: {{ params.normalization.rows_output if params.normalization.rows_output is not none else '—' }}</div>
          <div class="pill dim">Dropped (missing date): {{ params.normalization.rows_dropped_missing_date if params.normalization.rows_dropped_missing_date is not none else '—' }}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="pill dim">Duplicates dropped: {{ params.normalization.duplicates_dropped if params.normalization.duplicates_dropped is not none else '—' }}</div>
          <div class="pill dim">Amount parse invalid: {{ params.normalization.amount_parse_invalid if params.normalization.amount_parse_invalid is not none else '—' }}</div>
        </div>
        {% if params.normalization.applied_renames %}
          <div style="margin-top:10px;">
            <div style="font-weight:900; margin-bottom:6px;">Applied renames</div>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">From</th>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">To</th>
                </tr>
              </thead>
              <tbody>
                {% for r in params.normalization.applied_renames %}
                  <tr>
                    <td style="padding:6px 0;">{{ r.from }}</td>
                    <td style="padding:6px 0;">{{ r.to }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
        {% if params.normalization.duplicate_basis %}
          <div class="small" style="margin-top:10px; color:#334155;">
            Duplicate basis: {{ params.normalization.duplicate_basis|join(", ") }}
          </div>
        {% endif %}
      {% else %}
        <div class="small" style="color:var(--muted);">Normalization data not available for this run.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}
