{% extends "base.html" %}
{% block content %}
  <div class="header">
    <div>
      <h1 class="h1">Alert details</h1>
      <p class="sub"><span class="mono">{{ alert_id }}</span></p>
    </div>
    <div class="row">
      <a class="btn" href="/alerts{{ run_qs if run_qs is defined else "" }}">Back to Alerts</a>
      <a class="btn btn-ghost" href="/insights{{ run_qs if run_qs is defined else "" }}">Insights (same run)</a>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <div class="card-b">
        {% if alert_details %}
          <div class="badge {{ 'crit' if alert_details.severity=='critical' else ('warn' if alert_details.severity=='warning' else 'info') }}">
            {{ alert_details.severity|upper }}
          </div>
          <h2 style="margin-top:10px;">{{ alert_details.title }}</h2>
          <p class="sub" style="margin-top:6px; color:#334155;">{{ alert_details.why }}</p>
          {# Severity explanation #}
          <div class="small" style="margin-top:8px;">
            {% if alert_details.severity == 'critical' %}
              <strong>Critical:</strong> Material condition observed in the data.
            {% elif alert_details.severity == 'warning' %}
              <strong>Warning:</strong> Notable change or pattern observed in the data.
            {% elif alert_details.severity == 'info' %}
              <strong>Info:</strong> Informational signal; no material change detected.
            {% endif %}
          </div>
          {# Why didn't this fire explanation (expanded) #}
          <div class="small" style="margin-top:8px; color:var(--muted);">
            {% if alert_details.not_triggered_reason %}
              {{ alert_details.not_triggered_reason }}
            {% elif alert_details.suppression_reason %}
              Suppressed: {{ alert_details.suppression_reason }}
            {% else %}
              Not enough information is available to explain why this check did not trigger for this dataset.
            {% endif %}
          </div>
          {% if alert_details.quality_context %}
            <div class="small" style="margin-top:6px; color:var(--muted);">
              Data quality: {{ '%.0f'|format(alert_details.quality_context.score if alert_details.quality_context.score is not none else 0) }}/100
              (threshold {{ alert_details.quality_context.threshold if alert_details.quality_context.threshold is not none else '—' }})
            </div>
          {% endif %}
          <div class="hr"></div>
          <div style="font-weight:900; margin-bottom:8px;">Rule metadata (stored)</div>
          <table style="width:100%; border-collapse:collapse;">
            <tbody>
              <tr>
                <td style="padding:6px 0; font-weight:800;">Rule ID (stored)</td>
                <td style="padding:6px 0;">{{ alert_details.rule_id or "—" }}</td>
              </tr>
              <tr>
                <td style="padding:6px 0; font-weight:800;">Rule name (stored)</td>
                <td style="padding:6px 0;">{{ alert_details.rule_name or "—" }}</td>
              </tr>
              <tr>
                <td style="padding:6px 0; font-weight:800;">Rule version (stored)</td>
                <td style="padding:6px 0;">{{ alert_details.rule_version or "—" }}</td>
              </tr>
              <tr>
                <td style="padding:6px 0; font-weight:800;">Rule threshold (stored)</td>
                <td style="padding:6px 0;">{{ alert_details.rule_threshold or "—" }}</td>
              </tr>
              <tr>
                <td style="padding:6px 0; font-weight:800;">Data gates (stored)</td>
                <td style="padding:6px 0;">
                  {% if alert_details.data_requirements %}
                    {{ alert_details.data_requirements|join(", ") }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
          {% if alert_details.evidence and alert_details.evidence.items is defined %}
          <div class="hr"></div>
          <details>
            <summary style="cursor:pointer; font-weight:900;">Evidence (stored)</summary>
            <div class="small" style="margin-top:6px; color:var(--muted);">
              Evidence values are shown exactly as stored for this run.
            </div>
            <table style="width:100%; border-collapse:collapse; margin-top:10px;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Field</th>
                  <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Value</th>
                </tr>
              </thead>
              <tbody>
                {% for k, v in alert_details.evidence.items() %}
                  <tr>
                    <td style="padding:6px 0;">{{ k }}</td>
                    <td style="padding:6px 0;">{{ v }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </details>
          {% endif %}

          {% if alert_details.review_considerations %}
          <div class="hr"></div>
          <div style="font-weight:900; margin-bottom:8px;">Review considerations (stored)</div>
          <ul style="margin:0; padding-left:18px; color:#334155;">
            {% for s in alert_details.review_considerations %}
              <li style="margin:6px 0;">{{ s }}</li>
            {% endfor %}
          </ul>
          {% endif %}

          {% if alert_details.api_considerations %}
          <div class="hr"></div>
          <div style="font-weight:900; margin-bottom:8px;">API considerations (optional / future)</div>

          {% if alert_details.api_considerations.suggested_tools %}
            <div class="small" style="margin-bottom:6px; color:var(--muted);">
              <strong>Suggested tools:</strong> {{ alert_details.api_considerations.suggested_tools | join(", ") }}
            </div>
          {% endif %}

          {% if alert_details.api_considerations.external_context_types %}
            <div class="small" style="margin-bottom:6px; color:var(--muted);">
              <strong>Helpful context types:</strong> {{ alert_details.api_considerations.external_context_types | join(", ") }}
            </div>
          {% endif %}

          <div class="small" style="color:var(--muted);">
            These are implementation notes only. They do not change alert logic.
          </div>
          {% endif %}
        
          {% if chosen_run_meta or run_quality or categorisation_report %}
          <div class="hr"></div>
          <div style="font-weight:900; margin-bottom:8px;">Run context</div>

          {% if chosen_run_meta %}
            <div class="small" style="color:var(--muted); margin-bottom:6px;">
              <strong>Run:</strong> #{{ chosen_run_meta.id }} · {{ chosen_run_meta.created_at }} · {{ chosen_run_meta.filename }}
            </div>
          {% endif %}

          {% if run_quality %}
            <div class="small" style="color:var(--muted); margin-bottom:6px;">
              <strong>Data quality:</strong>
              {{ '%.0f'|format(run_quality.score if run_quality.score is not none else 0) }}/100
              {% if run_quality.band %} ({{ run_quality.band }}){% endif %}
            </div>

            {% if run_quality.flags %}
              <ul style="margin:0; padding-left:18px; color:#334155;">
                {% for f in run_quality.flags %}
                  <li style="margin:6px 0;">{{ f }}</li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endif %}

          {% if categorisation_report %}
            <div class="small" style="color:var(--muted); margin-top:10px;">
              <strong>Categorisation:</strong>
              {% if categorisation_report.enabled %}
                rules enabled ·
                {{ categorisation_report.categorised_rows if categorisation_report.categorised_rows is not none else '—' }} categorised ·
                {{ categorisation_report.uncategorised_rows if categorisation_report.uncategorised_rows is not none else '—' }} uncategorised
                {% if categorisation_report.uncategorised_share is not none %}
                  ({{ '%.0f'|format(100*categorisation_report.uncategorised_share) }}% uncategorised)
                {% endif %}
              {% else %}
                rules disabled
              {% endif %}
            </div>
          {% endif %}
          {% endif %}
{% else %}
          <div class="callout">This alert is not currently triggered in the latest run. You can still manage status and see audit history.</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-b">
        <h2>Manager action</h2>
        <div class="hr"></div>
        <form action="/alerts/{{ alert_id }}/update" method="post">
          <div class="field">
            <label>Status</label>
            <select name="status" {% if readonly %}disabled{% endif %}>
              {% set cur = state.status if state else 'review' %}
              {% for opt in ['review','expected','actioned','ignore','snoozed'] %}
                <option value="{{ opt }}" {{ 'selected' if cur==opt else '' }}>{{ opt|capitalize }}</option>
              {% endfor %}
            </select>
            <div class="small" style="color:var(--muted); font-size:12px; margin-top:6px;">
              Quieted alerts can automatically re-open if the issue worsens.
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>Note (optional)</label>
            <textarea name="note" id="alert-note" placeholder="E.g., expected annual insurance renewal; monitor again next month." {% if readonly %}disabled{% endif %} style="overflow-y:auto; max-height:12em; min-height:2.5em; resize:none;">{{ state.note if state and state.note is not none else '' }}</textarea>
          </div>
          <script>
            // Auto-expand textarea for notes, capped at ~8 lines (12em)
            (function() {
              var ta = document.getElementById('alert-note');
              if (!ta) return;
              function resize() {
                ta.style.height = 'auto';
                ta.style.height = Math.min(ta.scrollHeight, 192) + 'px'; // 192px ~12em
              }
              ta.addEventListener('input', resize);
              window.addEventListener('DOMContentLoaded', resize);
              resize();
            })();
          </script>

          <div class="row" style="margin-top:14px;">
            <button class="btn btn-primary" type="submit">Save</button>
            {% if state %}
              <div class="pill dim">Last updated: {{ state.updated_at|humandt }}</div>
              <div class="pill dim">Last score: {{ '%.2f'|format(state.last_score or 0) }}</div>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="grid cols-2">
    <div class="card">
      <div class="card-b">
        <h2>Audit trail</h2>
        <p class="sub" style="margin-top:6px;">Every change is recorded. Nothing disappears silently.</p>
        <p class="sub" style="margin-top:4px;">Events are shown in recorded order with stored status and note.</p>
        <div class="hr"></div>
        {% if not audit_allowed %}
          <div class="callout">Audit trail is available to admin or auditor access only.</div>
        {% elif events|length == 0 %}
          <div class="callout">No events recorded yet.</div>
        {% else %}
          <table class="table">
            <thead><tr><th>Time</th><th>Event</th><th>Status</th><th>Note</th><th>Run</th></tr></thead>
            <tbody>
              {% for e in events %}
              <tr>
                <td class="mono">{{ e.created_at|humandt }}</td>
                <td style="font-weight:800;">{{ e.event_type }}</td>
                <td>{{ e.status or '' }}</td>
                <td>{{ e.note or '' }}</td>
                <td>{% if e.run_id %}<a href="/run/{{ e.run_id }}">Run {{ e.run_id }}</a>{% else %}—{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-b">
        <h2>Where it appeared</h2>
        <p class="sub" style="margin-top:6px;">This section is unavailable because it requires derived scans.</p>
        <div class="hr"></div>
        <div class="callout">No stored run list is available for this alert.</div>
      </div>
    </div>
  </div>
{% endblock %}
