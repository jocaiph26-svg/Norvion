{% extends "base.html" %}
{% block content %}
  <div class="header">
    <div>
      <h1 class="h1">Insights</h1>
      <p class="sub">Plain-English highlights from your most recent data upload.</p>
    </div>
    <div class="row">
      <a class="btn" href="/alerts">Open Alerts</a>
    </div>
  </div>

  {# GLOBAL EMPTY STATE — no runs yet #}
  {% if empty %}
    <div class="card">
      <div class="card-b">
        <div class="empty">
          <div class="empty-title">No insights yet</div>
          <div class="empty-sub">
            Upload a CSV file to generate your first run. Once data is processed,
            this page will summarise what changed and what matters most.
          </div>
          <a class="btn primary" href="/upload">Upload CSV</a>
        </div>
      </div>
    </div>
  {% else %}

    {# --- Wording-only materiality logic (does NOT change calculations) --- #}
    {% set material_pct = 0.01 %} {# 1% threshold for "broadly flat" phrasing #}
    {% set income_chg = exec_summary.income_change %}
    {% set expense_chg = exec_summary.expense_change %}

    {% if income_chg is none %}
      {% set income_phrase = "Income change is unavailable for this comparison period." %}
    {% elif (income_chg|abs) < material_pct %}
      {% set income_phrase = "Income is broadly flat (within ±1%) over the most recent comparison period." %}
    {% else %}
      {% set income_phrase = "Income changed by " ~ (income_chg|pct) ~ " over the most recent comparison period." %}
    {% endif %}

    {% if expense_chg is none %}
      {% set expense_phrase = "Expense change is unavailable for this comparison period." %}
    {% elif (expense_chg|abs) < material_pct %}
      {% set expense_phrase = "Expenses are broadly flat (within ±1%) over the most recent comparison period." %}
    {% else %}
      {% set expense_phrase = "Expenses changed by " ~ (expense_chg|pct) ~ " over the most recent comparison period." %}
    {% endif %}

    <div class="card">
      <div class="card-b">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2>Manager briefing</h2>
            <p class="sub" style="margin-top:6px;">
              Compared to the previous upload (run {{ prev_run_id }}), here’s what changed.
            </p>
            <p class="sub" style="margin-top:6px;">
              Run context:
              <span class="mono">#{{ latest_run_id }}</span>
              {% if latest_summary.comparison_label %} • {{ latest_summary.comparison_label }}{% endif %}
              {% if latest_summary.comparison_kind %} • {{ latest_summary.comparison_kind }}{% endif %}
              {% if latest_summary.alert_quality_gate and latest_summary.alert_quality_gate.threshold is not none %}
                • quality threshold {{ latest_summary.alert_quality_gate.threshold }}
                {% if latest_summary.alert_quality_gate.suppressed %}(suppressed){% endif %}
              {% endif %}
              {% if latest_summary.non_trigger_explainability %}
                • non-triggers {{ latest_summary.non_trigger_explainability|length }}
              {% endif %}
            </p>
          </div>
          <div class="pill dim">
            Latest run: <strong>{{ latest_run_id }}</strong> • {{ latest_created_at|humandt }}
          </div>
          <div class="pill dim">
            Data Quality:
            {% if latest_summary.quality and latest_summary.quality.score is not none %}
              <strong>{{ '%.0f'|format(latest_summary.quality.score) }}/100</strong>
              <span class="small" style="display:block; color:var(--muted);">
                This score reflects the completeness and coverage of the uploaded data. Higher scores reflect greater data completeness. A score of 100 reflects fully complete data for the checks performed; lower scores may reflect missing or partial fields.<br>
                {% if latest_summary.quality.score >= 90 %}High completeness
                {% elif latest_summary.quality.score >= 70 %}Moderate completeness
                {% elif latest_summary.quality.score >= 50 %}Partial completeness
                {% else %}Limited data coverage
                {% endif %}
              </span>
            {% else %}
              <strong>—</strong>
              <span class="small" style="display:block; color:var(--muted);">
                Data quality information is not available for this run.
              </span>
            {% endif %}
          </div>
        </div>

        <div class="hr"></div>

        <div class="callout">
  Current cash is <strong>{{ exec_summary.current_cash|money(exec_summary.currency) }}</strong>
  {% if runway_na %}
    with runway <strong>N/A</strong>.
    <span class="sub">{{ runway_note }}</span>
  {% elif exec_summary.runway_days is not none and exec_summary.runway_days <= 0 %}
    with runway <strong>Overdrawn</strong>.
  {% elif exec_summary.runway_days is not none %}
    with an estimated runway of <strong>{{ '%.0f'|format(exec_summary.runway_days) }} days</strong>.
  {% else %}
    with runway <strong>—</strong>.
  {% endif %}
  {{ income_phrase }} {{ expense_phrase }}
</div>

        {% if insights and insights|length > 0 %}
          <div class="card" style="margin-top:14px;">
            <div class="card-b">
              <h2>Deterministic narratives</h2>
              <p class="sub" style="margin-top:6px;">Observations derived from the run inputs, rules, and thresholds.</p>
              <div class="hr"></div>
              {% for n in insights %}
                <div style="margin-bottom:12px;">
                  <div style="font-weight:900;">{{ n.title }}</div>
                  <div class="small" style="color:#334155; margin-top:4px;">{{ n.text }}</div>
                  {% if n.evidence %}
                    <div class="small" style="color:var(--muted); margin-top:6px;">
                      Evidence (stored):
                      {% for k, v in n.evidence.items() %}
                        <span class="mono">{{ k }}={{ v }}</span>{% if not loop.last %}, {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}


        <div class="grid cols-3" style="margin-top:14px;">
          <div class="card">
            <div class="card-b">
              <div class="label" style="color:var(--muted); font-weight:900; letter-spacing:.08em; font-size:12px;">
                NEW RISKS
              </div>
              {% if new_alerts|length == 0 %}
                <p class="sub">No new alert types since the last upload.</p>
              {% else %}
                <ul style="margin:10px 0 0; padding-left:18px;">
                  {% for a in new_alerts %}
                    <li><a href="/alerts/{{ a }}{{ run_qs if run_qs is defined else '' }}"><span class="mono">{{ a }}</span></a></li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>

          <div class="card">
            <div class="card-b">
              <div class="label" style="color:var(--muted); font-weight:900; letter-spacing:.08em; font-size:12px;">
                CONTINUING RISKS
              </div>
              <p class="sub">
                Some risks remain active. Visit the Alerts page to review status,
                notes, and next actions.
              </p>
            </div>
          </div>

          <div class="card">
            <div class="card-b">
              <div class="label" style="color:var(--muted); font-weight:900; letter-spacing:.08em; font-size:12px;">
                RESOLVED / IMPROVEMENTS
              </div>
              {% if cleared_alerts|length == 0 %}
                <p class="sub">No alert types cleared since the last upload.</p>
              {% else %}
                <ul style="margin:10px 0 0; padding-left:18px;">
                  {% for a in cleared_alerts %}
                    <li><a class="mono" href="/alerts/{{ a }}?readonly=1{{ '&' if (run_qs is defined and run_qs) else '' }}{{ (run_qs[1:] if run_qs is defined and run_qs and run_qs.startswith('?') else run_qs) if run_qs is defined else '' }}">{{ a }}</a></li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>
        </div>

        <details style="margin-top:14px;">
          <summary style="cursor:pointer; font-weight:900;">View detailed numbers</summary>
          <p class="sub" style="margin-top:6px;">All values below are stored from the run snapshot; no recomputation.</p>
          <div class="hr"></div>

          <div class="grid cols-2">
            <div class="card">
              <div class="card-b">
                <h2>Latest snapshot</h2>
                <div class="hr"></div>
                <div class="row">
                  <div class="pill">Cash: <strong>{{ latest_summary.current_cash|money(latest_summary.currency) }}</strong></div>
                  <div class="pill">
  Runway:
  <strong>
    {% if runway_na %}
      N/A
    {% elif latest_summary.runway_days is not none and latest_summary.runway_days <= 0 %}
      Overdrawn
    {% elif latest_summary.runway_days is not none %}
      {{ '%.0f'|format(latest_summary.runway_days) }} days
    {% else %}
      —
    {% endif %}
  </strong>
</div>

                  <div class="pill">Income: <strong>{{ latest_summary.recent_income|money(latest_summary.currency) }}</strong></div>
                  <div class="pill">Expenses: <strong>{{ latest_summary.recent_expense|money(latest_summary.currency) }}</strong></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-b">
                <h2>Delta vs previous</h2>
                <div class="hr"></div>
                <div class="row">
                  {% for k,v in delta.items() %}
                    <div class="pill dim">
                      {{ k }}: <strong>{{ v if v is not none else '—' }}</strong>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>

  {% endif %}
{% endblock %}
