{% extends "base.html" %}
{% block content %}
  <div class="header">
    <div>
      <h1 class="h1">History</h1>
      <p class="sub">Saved runs (audit trail builds trust and repeat usage).</p>
    </div>
  </div>
  <style>
    .clickrow { cursor: pointer; }
    .clickrow:hover { background: rgba(2,6,23,0.03); }
  </style>

  {% if runs and runs|length > 0 %}
    <div class="card">
      <div class="card-b" style="padding:0;">
        <table class="table">
          <thead>
            <tr>
              <th>Date (UTC)</th>
              <th>File</th>
              <th>Period end</th>
              <th>Cash</th>
              <th>Runway</th>
              <th>Quality</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          {% for r in runs %}
            <tr class="clickrow" onclick="window.location='/run/{{ r.id }}'">
              <td class="mono">{{ r.created_at|humandt }}</td>
              <td style="font-weight:800;">{{ r.filename }}</td>
              <td>{{ r.end_date }}</td>
              <td>{{ r.current_cash | money(r.currency) }}</td>
              <td>
                {% if r.runway_na %}
                  N/A
                {% elif r.runway_days is not none and r.runway_days <= 0 %}
                  Overdrawn
                {% elif r.runway_days is not none %}
                  {{ '%.0f'|format(r.runway_days) }} days
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="font-weight:900;">
                {% if r.quality_score is not none %}
                  {{ '%.0f'|format(r.quality_score) }}/100{% if r.quality_band %} ({{ r.quality_band }}){% endif %}
                  <span class="small" style="display:block; color:var(--muted);">
                    This score reflects the completeness and coverage of the uploaded data. Higher scores reflect greater data completeness. A score of 100 reflects fully complete data for the checks performed; lower scores may reflect missing or partial fields.
                    {% if r.quality_score >= 90 %}High completeness
                    {% elif r.quality_score >= 70 %}Moderate completeness
                    {% elif r.quality_score >= 50 %}Partial completeness
                    {% else %}Limited data coverage
                    {% endif %}
                  </span>
                  {% if r.quality_flags %}
                    <ul style="margin:8px 0 0; padding-left:18px; color:#334155;">
                      {% for f in r.quality_flags %}
                        <li style="margin:6px 0;">{{ f }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}

                {% else %}
                  —
                  <span class="small" style="display:block; color:var(--muted);">
                    Data quality information is not available for this run.
                  </span>
                {% endif %}
              </td>
              <td><a href="/run/{{ r.id }}">Open</a></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="card">
      <div class="card-b">
        <div class="empty">
          <div class="empty-title">No runs yet</div>
          <div class="empty-sub">
            Upload a CSV file to generate your first run. Each run is saved here
            so you can track changes and maintain a clear audit trail.
          </div>
          <a class="btn primary" href="/upload">Upload CSV</a>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
