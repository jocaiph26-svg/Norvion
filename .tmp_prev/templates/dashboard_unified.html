{% extends "base.html" %}
{% block content %}
  <div class="header">
    <div>
      <h1 class="h1">Home</h1>
      <p class="sub">A calm view of cash health and risks — designed for owner-managers.</p>
      {% if latest_run %}
        <p class="sub" style="margin-top:8px;">
          Latest dataset:
          <span class="mono">{{ latest_run.created_at }}</span>
          ({{ latest_run.filename }})
        </p>
        <p class="sub" style="margin-top:6px;">
          Entity (stored at run time): <span class="mono">{{ latest_run.tenant_id or "—" }}</span>
        </p>
        {% if authorized_entities %}
          <p class="sub" style="margin-top:6px;">
            Entities in access history (stored): {{ authorized_entities|join(", ") }}
          </p>
        {% endif %}
        {% set s = latest_run.summary %}
        <div class="pill dim" style="margin-top:10px;">
          Run context:
          <strong>#{{ latest_run.id }}</strong>
          {% if s.comparison_label %} • {{ s.comparison_label }}{% endif %}
          {% if s.comparison_kind %} • {{ s.comparison_kind }}{% endif %}
          {% if s.alert_quality_gate and s.alert_quality_gate.threshold is not none %}
            • quality threshold {{ s.alert_quality_gate.threshold }}
            {% if s.alert_quality_gate.suppressed %}(suppressed){% endif %}
          {% endif %}
          {% if s.non_trigger_explainability %}
            • non-triggers {{ s.non_trigger_explainability|length }}
          {% endif %}
        </div>
      {% endif %}
    </div>
    <div class="row">
      <div class="badge">
        LATEST RUN
        <strong style="margin-left:6px;">
          {{ latest_run.id if latest_run else '—' }}
        </strong>
      </div>
      <a class="btn primary" href="/upload">Upload new data</a>
      {% if latest_run %}
        <div class="badge">
          Data Quality
          <strong style="margin-left:6px;">
            {{ '%.0f'|format(latest_run.quality.score if latest_run.quality else 0) }}/100{% if latest_run.quality and latest_run.quality.band %} ({{ latest_run.quality.band }}){% endif %}
          </strong>
          <span class="small" style="display:block; color:var(--muted);">
            {% if latest_run.quality and latest_run.quality.score is not none %}
              This score reflects the completeness and coverage of the uploaded data. Higher scores reflect greater data completeness. A score of 100 reflects fully complete data for the checks performed; lower scores may reflect missing or partial fields.<br>
              {% if latest_run.quality.score >= 90 %}High completeness
              {% elif latest_run.quality.score >= 70 %}Moderate completeness
              {% elif latest_run.quality.score >= 50 %}Partial completeness
              {% else %}Limited data coverage
              
              {% endif %}
              {% if latest_run.quality.flags %}
                <ul style="margin:8px 0 0; padding-left:18px; color:#334155;">
                  {% for f in latest_run.quality.flags %}
                    <li style="margin:6px 0;">{{ f }}</li>
                  {% endfor %}
                </ul>
              {% endif %}

            {% else %}
              Data quality information is not available for this run.
            {% endif %}
          </span>
        </div>
      {% endif %}
    </div>
  </div>

  {% if not latest_run %}
    <div class="card">
      <div class="card-b empty">
        <div class="empty-title">No data yet</div>
        <div class="empty-sub">
          Upload a transactions CSV to generate your first dashboard, alerts, and insights.
        </div>
        <a class="btn primary" href="/upload">Upload CSV</a>
      </div>
    </div>
  {% else %}
    {% set s = latest_run.summary %}

    <div class="grid cols-4">
      <div class="card kpi">
        <div class="label">Current cash</div>
        <div class="value">{{ s.current_cash|money(s.currency) }}</div>
        <div class="hint">Cash position calculated from the uploaded window.</div>
      </div>

      <div class="card kpi">
        <div class="label">Runway</div>
        <div class="value">
          {% if s.runway_na %}
            N/A
          {% elif s.runway_days is not none and s.runway_days <= 0 %}
            Overdrawn
          {% elif s.runway_days is not none %}
            {{ '%.0f'|format(s.runway_days) }} days
          {% else %}
            —
          {% endif %}
        </div>
        <div class="hint">
          {% if s.runway_na %}
            {{ s.runway_note }}
          {% elif s.runway_days is not none and s.runway_days <= 0 %}
            Cash is negative or runway ≤ 0.
          {% elif s.runway_days is not none %}
            Estimated runway using recent burn.
          {% else %}
            —
          {% endif %}
        </div>
      </div>

      <div class="card kpi">
        <div class="label">Recent income</div>
        <div class="value">{{ s.recent_income|money(s.currency) }}</div>
        <div class="hint">Incoming cash in the most recent compare window.</div>
      </div>

      <div class="card kpi">
        <div class="label">Recent expenses</div>
        <div class="value">{{ s.recent_expense|money(s.currency) }}</div>
        <div class="hint">Outgoing cash in the most recent compare window.</div>
      </div>
    </div>

    <div style="height:14px;"></div>

    <div class="card">
      <div class="card-b">
        <h2>Window totals (stored at run time)</h2>
        <div class="small" style="margin-top:6px; color:var(--muted);">
          Window: {{ s.window_start_date or "—" }} to {{ s.end_date or "—" }} (inclusive).
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="pill">Window income (stored): {{ s.window_income|money(s.currency) }}</div>
          <div class="pill dim">Window expense (stored): {{ s.window_expense|money(s.currency) }}</div>
          <div class="pill dim">Window net change (stored): {{ s.window_net_change|money(s.currency) }}</div>
        </div>
      </div>
    </div>

    <div style="height:14px;"></div>

    <div class="card">
      <div class="card-b">
        <h2>Coverage (stored at run time)</h2>
        <div class="small" style="margin-top:6px; color:var(--muted);">
          Distinct dates observed are counted from post-normalization rows within the window.
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="pill">Transactions in window (stored): {{ s.window_transaction_count if s.window_transaction_count is not none else "—" }}</div>
          <div class="pill dim">Distinct dates observed (stored): {{ s.window_days_observed if s.window_days_observed is not none else "—" }}</div>
          <div class="pill dim">Window span (stored, inclusive): {{ s.window_days_span_inclusive if s.window_days_span_inclusive is not none else "—" }}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="pill dim">Days with income (stored): {{ s.window_days_with_income if s.window_days_with_income is not none else "—" }}</div>
          <div class="pill dim">Days with expense (stored): {{ s.window_days_with_expense if s.window_days_with_expense is not none else "—" }}</div>
        </div>
      </div>
    </div>

    <div style="height:14px;"></div>

    <div class="card">
      <div class="card-b">
        <h2>Observed distribution (stored at run time)</h2>
        <div class="small" style="margin-top:6px; color:var(--muted);">
          Top {{ s.concentration_top_n if s.concentration_top_n is not none else "—" }} by share of total window expense (denominator: {{ s.concentration_expense_denominator|money(s.currency) }}).
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="pill">Vendors (stored)</div>
        </div>
        {% if s.concentration_top_vendors_expense and s.concentration_top_vendors_expense|length > 0 %}
          <table style="width:100%; border-collapse:collapse; margin-top:8px;">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Vendor</th>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Amount (stored)</th>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Share (stored)</th>
              </tr>
            </thead>
            <tbody>
              {% for v in s.concentration_top_vendors_expense %}
                <tr>
                  <td style="padding:6px 0;">{{ v.counterparty }}</td>
                  <td style="padding:6px 0;">{{ v.amount|money(s.currency) }}</td>
                  <td style="padding:6px 0;">{{ v.share|pct }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="small" style="margin-top:6px; color:var(--muted);">—</div>
        {% endif %}

        <div class="row" style="margin-top:12px;">
          <div class="pill">Categories (stored)</div>
        </div>
        {% if s.concentration_top_categories_expense and s.concentration_top_categories_expense|length > 0 %}
          <table style="width:100%; border-collapse:collapse; margin-top:8px;">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Category</th>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Amount (stored)</th>
                <th style="text-align:left; border-bottom:1px solid #e2e8f0; padding:6px 0;">Share (stored)</th>
              </tr>
            </thead>
            <tbody>
              {% for c in s.concentration_top_categories_expense %}
                <tr>
                  <td style="padding:6px 0;">{{ c.category }}</td>
                  <td style="padding:6px 0;">{{ c.amount|money(s.currency) }}</td>
                  <td style="padding:6px 0;">{{ c.share|pct }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="small" style="margin-top:6px; color:var(--muted);">—</div>
        {% endif %}
      </div>
    </div>

    <div style="height:14px;"></div>

    <div class="card">
      <div class="card-b">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2>What matters now</h2>
            <p class="sub" style="margin-top:6px;">
              Top alerts from the latest dataset. Click through to manage, note, and audit changes.
            </p>
          </div>
          <a class="btn btn-ghost" href="/alerts">Open Alerts Control Panel</a>
        </div>

        <div class="hr"></div>

        {% if latest_run.alerts|length == 0 %}
          <div class="callout">
            <strong>No alerts were triggered for this run.</strong> Some checks may not have been evaluated if required data was missing.
          </div>
        {% else %}
          <div class="grid">
            {% for a in latest_run.alerts[:5] %}
              {% set aid = a.alert_id if a.alert_id is defined and a.alert_id else a.id %}
              <div class="alert">
                <div class="badge {{ 'crit' if a.severity=='critical' else ('warn' if a.severity=='warning' else 'info') }}">
                  {{ a.severity|upper }}
                </div>
                <div class="meta">
                  <p class="title">{{ a.title }}</p>
                  <p class="why">{{ a.why }}</p>
                </div>
                <div class="right">
                  <a class="btn btn-sm" href="/alerts/{{ aid }}">Manage</a>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endblock %}
